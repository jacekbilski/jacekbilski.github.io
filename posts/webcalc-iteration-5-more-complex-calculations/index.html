<!DOCTYPE html>
<html lang="en-gb">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="Jacek Bilski">
<meta name="generator" content="Hugo 0.65.3" />

    
    
    

<title>Iteration 5 - more complex calculations • On Software Engineering</title>
<meta name="description" content="In WebCalc&#39;s fifth iteration I&#39;m adding support for more complex calculations. I&#39;m also finally dealing with dependency management.">
<meta name="keywords" content="Gradle, obvious implementation, testing">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iteration 5 - more complex calculations"/>
<meta name="twitter:description" content="In WebCalc&#39;s fifth iteration I&#39;m adding support for more complex calculations. I&#39;m also finally dealing with dependency management."/>
<meta name="twitter:site" content="@jacek_bilski"/>

<meta property="og:title" content="Iteration 5 - more complex calculations" />
<meta property="og:description" content="In WebCalc&#39;s fifth iteration I&#39;m adding support for more complex calculations. I&#39;m also finally dealing with dependency management." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.bilski.tech/posts/webcalc-iteration-5-more-complex-calculations/" />
<meta property="article:published_time" content="2018-12-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-12-18T00:00:00+00:00" />



    






<link rel="stylesheet" href="/scss/hyde-hyde.e1328bd2782dc12d009c9e01c8a9883d286ee0815d48539334d945277ec599ee.css" integrity="sha256-4TKL0ngtwS0AnJ4ByKmIPShu4IFdSFOTNNlFJ37Fme4=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    
<link href='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.css' rel='stylesheet' type='text/css'/>
<style type='text/css'>
.d2h-wrapper {
    color: black;
    background: white;
    line-height: normal;
}
.d2h-wrapper td {
    padding: 0;
    border: none;
}
.d2h-wrapper table {
    margin-bottom: 0;
}
.d2h-file-diff {
    overflow-x: auto;
}
</style>
<script src='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.js' type='text/javascript'></script>


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.bilski.tech/">On Software Engineering</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://www.bilski.tech/img/jacek.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Jacek Bilski&#39;s thoughts about software engineering and how to improve it 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">On Software Engineering</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/various/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/webcalc/">
						<span>WebCalc</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jacek_bilski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/jacekbilski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/jacek-bilski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://www.xing.com/profile/Jacek_Bilski3" rel="me"><i class="fab fa-xing fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Iteration 5 - more complex calculations</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 18, 2018<br/>
    
    <i class="fas fa-user-edit"></i> Jacek Bilski
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/gradle">gradle</a>
           
      
          <a class="badge badge-tag" href="/tags/obvious-implementation">obvious implementation</a>
           
      
          <a class="badge badge-tag" href="/tags/testing">testing</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Welcome everyone to the fifth iteration of WebCalc. <a href="/posts/webcalc-iteration-4-fixes-only/">Previously</a>
 I only managed to fix a few issues with the code and upgrade Java, Spring Boot and Gradle. This time I&rsquo;ll get back to adding new functionalities and add a possibility to do more complex calculations like <code>1+2+3</code>. To IDE then!</p>
<p>But first, let&rsquo;s deal with some technical issues. One is upgrading Gradle to stable version 5.0. Having installed it locally on my machine, I can just call <code>gradle wrapper --gradle-version=5.0 --distribution-type=all</code> and that&rsquo;s it, see <a href="https://github.com/jacekbilski/WebCalc/commit/14c17dc3deddc5219f50aa5c27da7926ea61a3fc" target="_blank">commit 14c17dc3</a>
.</p>
<p>The second thing is this possible bug in Spring Boot Gradle plugin I was complaining about previously. I did some investigation and, although there might be something not exactly right with this plugin, the problem is actually how I&rsquo;m using both that and dependency-management plugins. I should have done RFTM long time ago. Knowing how to do it properly I can now just import spring-boot-dependencies BOM and have all versions in all modules in sync, see <a href="https://github.com/jacekbilski/WebCalc/commit/2de6a84c8a0ca48364e39e73b9da990ab093c576" target="_blank">commit 2de6a84c</a>
. I must admit though that I&rsquo;m still not sure 100% if that&rsquo;s the correct way, especially given that two ways of applying plugins in Gradle do not merely differ in syntax.</p>
<p>Short mental detour. Outside of this project, I&rsquo;m recently trying to find a balance between two aspects of developing software: delivering business value and good engineering. On one hand, I have a feeling, that we&rsquo;re too focused on technical details, like using the newest and the most hype technology there is, but providing very little actual value to our stakeholders. On the other hand, we can be so focused on the business value that we are ignoring good engineering practices like keeping cohesion high and coupling low. Not many conclusions yet, but I believe, that we should keep our tools reasonably up-to-date. In order to not spend too much time on that, we need to know how to use them properly and not to couple them too tightly to everything else. That&rsquo;s why I allowed myself to go for all those improvements and fixes lately. Happy to discuss if someone feels like.</p>
<p>Having technical issues out of the way, I can again focus on the code. First, I noticed, that some tests use helper methods I created, some are not. That&rsquo;s easy to fix:</p>


<span id="fcb2d0ba16445a2f0f45dd0a5ec85abf3bd6511c"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -14,32 \x2b14,14 @@\n\n   @Test\n   void invokesWebCalcRestApi() {\n-    given()\n-        .body(\x221 2 \x2b\x22)\n-    .when()\n-        .post(\x22\/eval\x22)\n-    .then()\n-        .body(equalTo(\x223\x22));\n\x2b    assertEvalResult(\x221 2 \x2b\x22, \x223\x22);\n   }\n\n   @Test\n   void settingMaxFractionDigits() {\n     SessionFilter session = new SessionFilter();\n-    given()\n-        .filter(session)\n-        .body(\x225\x22)\n-    .when()\n-        .put(\x22\/maxFractionDigits\x22)\n-    .then()\n-        .statusCode(200);\n-\n-    given()\n-        .filter(session)\n-        .body(\x228 7 \/\x22)\n-    .when()\n-        .post(\x22\/eval\x22)\n-    .then()\n-        .body(equalTo(\x221,14286\x22));\n\x2b    setMaxFractionDigitsForSession(5, session);\n\x2b    assertEvalResultForSession(\x228 7 \/\x22, \x221,14286\x22, session);\n   }\n\n   @Test\n@@ -65,6 \x2b47,10 @@\n         .statusCode(200);\n   }\n\n\x2b  private void assertEvalResult(String expression, String expectedResult) {\n\x2b    assertEvalResultForSession(expression, expectedResult, new SessionFilter());\n\x2b  }\n\x2b\n   private void assertEvalResultForSession(String expression, String expectedResult, SessionFilter session) {\n     given()\n         .filter(session)\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("fcb2d0ba16445a2f0f45dd0a5ec85abf3bd6511c").innerHTML = diffHtml;
</script>

<p>Finally, I can make some progress in terms of functionality. My goal is to have a possibility of calculating expressions like <code>1+2+3</code>. This time, however, I&rsquo;ll start not by writing a test. To make it pass I&rsquo;d need to spend quite some time, but I don&rsquo;t want to be &ldquo;in the red&rdquo; for too long. I&rsquo;m using reverse Polish notation and there&rsquo;s a known algorithm how to do calculations using it. I&rsquo;ll go for obvious implementation. I&rsquo;ll also do it &ldquo;first make the change easy, then make the easy change&rdquo; way. The first step would be to start using Stack in Calculator and keep all current tests green, like so:</p>


<span id="6a03314ba3a58bca5e20c4c3d31a5b5d2c3fdd82"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -6,6 \x2b6,7 @@\n import java.text.NumberFormat;\n import java.text.ParseException;\n import java.util.Locale;\n\x2bimport java.util.Stack;\n import java.util.function.BinaryOperator;\n\n public class Calculator {\n@@ -22,11 \x2b23,14 @@\n\n   String eval(String input, int maxFractionDigits) {\n     String[] tokens = input.split(\x22 \x22);\n-    BigDecimal v1 = parse(tokens[0]);\n-    BigDecimal v2 = parse(tokens[1]);\n-    BinaryOperator\x3cbigdecimal\x3e f = function(tokens[2], maxFractionDigits);\n-    BigDecimal result = f.apply(v1, v2);\n-    return format(result, maxFractionDigits);\n\x2b    var stack = new Stack\x3cbigdecimal\x3e();\n\x2b    stack.push(parse(tokens[0]));\n\x2b    stack.push(parse(tokens[1]));\n\x2b    var f = function(tokens[2], maxFractionDigits);\n\x2b    var a = stack.pop();\n\x2b    var b = stack.pop();\n\x2b    stack.push(f.apply(b, a));\n\x2b    return format(stack.pop(), maxFractionDigits);\n   }\n\n   private BinaryOperator\x3cbigdecimal\x3e function(String function, int maxFractionDigits) {\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("6a03314ba3a58bca5e20c4c3d31a5b5d2c3fdd82").innerHTML = diffHtml;
</script>

<p>I just used for the first time <code>var</code> keyword. It feels like I&rsquo;m giving up on type safety, but I&rsquo;m also removing a few characters from the code, so the rest should theoretically be more &ldquo;meaningful&rdquo;. I&rsquo;ll see where that goes, maybe it&rsquo;s not a bad idea after all.</p>
<p>OK, I now have a partially implemented algorithm for doing calculations in reverse Polish notation. It only supports one operator, but it&rsquo;s sufficient to keep my tests green. Can I go towards the full algorithm already? I don&rsquo;t think so, it&rsquo;s too early, now I need a new test.</p>


<span id="83284c6f22388e9f85d6ea44dacbc6f644f32877"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -37,6 \x2b37,11 @@\n     assertEvalResultForSession(expression, \x221,14286\x22, session2);\n   }\n\n\x2b  @Test\n\x2b  void canDoComplexCalculations() {\n\x2b    assertEvalResult(\x221 2 3 \x2b \x2b\x22, \x226\x22);\n\x2b  }\n\x2b\n   private void setMaxFractionDigitsForSession(int maxFractionDigits, SessionFilter session) {\n     given()\n         .filter(session)\nIndex: calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n===================================================================\n--- calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n\x2b\x2b\x2b calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n@@ -66,4 \x2b66,14 @@\n     String result = calculator.eval(input, maxFractionDigits);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n\x2b\n\x2b  @DisplayName(\x22Complex calculations\x22)\n\x2b  @ParameterizedTest(name = \x22input: \x27\x27{0}\x27\x27, expected result: \x27\x27{1}\x27\x27\x22)\n\x2b  @CsvSource({\n\x2b      \x221 2 3 \x2b \x2b, 6\x22,\n\x2b  })\n\x2b  void complexCalculations(String input, String expectedResult) {\n\x2b    String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n\x2b    assertThat(result).isEqualTo(expectedResult);\n\x2b  }\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("83284c6f22388e9f85d6ea44dacbc6f644f32877").innerHTML = diffHtml;
</script>

<p>I created two tests, one on REST API level and one unit test. They verify exactly the same behaviour, but on different levels. REST is what I&rsquo;m actually after, but unit tests let me work much faster and get the feedback earlier.</p>
<p>As expected, the tests fail. I need to introduce a loop in the Calculator, like so:</p>


<span id="d90e93c750640d1d99df4b541ed3f3fd55d4f940"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -24,12 \x2b24,17 @@\n   String eval(String input, int maxFractionDigits) {\n     String[] tokens = input.split(\x22 \x22);\n     var stack = new Stack\x3cbigdecimal\x3e();\n-    stack.push(parse(tokens[0]));\n-    stack.push(parse(tokens[1]));\n-    var f = function(tokens[2], maxFractionDigits);\n-    var a = stack.pop();\n-    var b = stack.pop();\n-    stack.push(f.apply(b, a));\n\x2b    for (String token : tokens) {\n\x2b      try {\n\x2b        var value = parse(token);\n\x2b        stack.push(value);\n\x2b      } catch (Exception e) {\n\x2b        var f = function(token, maxFractionDigits);\n\x2b        var a = stack.pop();\n\x2b        var b = stack.pop();\n\x2b        stack.push(f.apply(b, a));\n\x2b      }\n\x2b    }\n     return format(stack.pop(), maxFractionDigits);\n   }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("d90e93c750640d1d99df4b541ed3f3fd55d4f940").innerHTML = diffHtml;
</script>

<p>I&rsquo;m relying in here on exceptions to differentiate between numbers and functions, which I&rsquo;m not entirely fond of, but it&rsquo;s enough to make my tests green. In a real world that would probably be not enough and I&rsquo;d need to revisit this place later on.</p>
<p>That should honestly be about it when it comes to the algorithm itself. To verify this I&rsquo;ll add a few more test cases:</p>


<span id="9fcc50c3688ea01fa7a356e5d21429061a92964a"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n===================================================================\n--- calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n\x2b\x2b\x2b calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n@@ -71,6 \x2b71,10 @@\n   @ParameterizedTest(name = \x22input: \x27\x27{0}\x27\x27, expected result: \x27\x27{1}\x27\x27\x22)\n   @CsvSource({\n       \x221 2 3 \x2b \x2b, 6\x22,\n\x2b      \x222 3 4 \x2b *, 14\x22,\n\x2b      \x22\x273,2 2,8 2 \/ -\x27, \x271,8\x27\x22,\n\x2b      \x221 2 3 4 5 * * * *, 120\x22,\n\x2b      \x221 2 \x2b 3 *, 9\x22,\n   })\n   void complexCalculations(String input, String expectedResult) {\n     String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("9fcc50c3688ea01fa7a356e5d21429061a92964a").innerHTML = diffHtml;
</script>

<p>Looks good, I cannot find a use case, where my implementation would fail. I&rsquo;m sure you can figure something out, like trying to use all memory.</p>
<p>That would be all for this time. I think I have enough of my &ldquo;business logic&rdquo; and can go to more tricky parts like users, security and billing. That&rsquo;s the part where I&rsquo;ll be going into the unknown myself. See you <a href="/posts/webcalc-iteration-6-introducing-users/">there</a>
!</p>

  </div>
  


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="jacekbilski/jacekbilski.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
