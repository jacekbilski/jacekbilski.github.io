<!DOCTYPE html>
<html lang="en-gb">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="Jacek Bilski">
<meta name="generator" content="Hugo 0.67.1" />

    
    
    

<title>Iteration 8 - billing module extraction and differentiating users • On Software Engineering</title>
<meta name="description" content="In WebCalc&#39;s eighth iteration I&#39;m fixing mistakes I made previously while trying, at the same time, introduce differentiation of users - bad idea.">
<meta name="keywords" content="TDD, learning, mistakes, Spring Security, context">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iteration 8 - billing module extraction and differentiating users"/>
<meta name="twitter:description" content="In WebCalc&#39;s eighth iteration I&#39;m fixing mistakes I made previously while trying, at the same time, introduce differentiation of users - bad idea."/>
<meta name="twitter:site" content="@jacek_bilski"/>

<meta property="og:title" content="Iteration 8 - billing module extraction and differentiating users" />
<meta property="og:description" content="In WebCalc&#39;s eighth iteration I&#39;m fixing mistakes I made previously while trying, at the same time, introduce differentiation of users - bad idea." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.bilski.tech/posts/webcalc-iteration-8-billing-module-extraction-and-differentiating-users/" />
<meta property="article:published_time" content="2019-05-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-05-13T00:00:00+00:00" />



    






<link rel="stylesheet" href="/scss/hyde-hyde.302e105633e7b74ff627e4a63c9fc0dc7446d15c60a7a4a2e12da987fdd9de0e.css" integrity="sha256-MC4QVjPnt0/2J&#43;SmPJ/A3HRG0Vxgp6Si4S2ph/3Z3g4=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

    
<link href='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.css' rel='stylesheet' type='text/css'/>
<style type='text/css'>
.d2h-wrapper {
    color: black;
    background: white;
    line-height: normal;
}
.d2h-wrapper td {
    padding: 0;
    border: none;
}
.d2h-wrapper table {
    margin-bottom: 0;
}
.d2h-file-diff {
    overflow-x: auto;
}
</style>
<script src='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.js' type='text/javascript'></script>


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.bilski.tech/">On Software Engineering</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://www.bilski.tech/img/jacek.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Jacek Bilski&#39;s thoughts about software engineering and how to improve it 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">On Software Engineering</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/various/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/webcalc/">
						<span>WebCalc</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/videos/">
						<span>Videos</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jacek_bilski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/jacekbilski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/jacek-bilski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://www.xing.com/profile/Jacek_Bilski3" rel="me"><i class="fab fa-xing fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Iteration 8 - billing module extraction and differentiating users</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 13, 2019<br/>
    
    <i class="fas fa-user-edit"></i> Jacek Bilski
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/tdd">tdd</a>
           
      
          <a class="badge badge-tag" href="/tags/learning">learning</a>
           
      
          <a class="badge badge-tag" href="/tags/mistakes">mistakes</a>
           
      
          <a class="badge badge-tag" href="/tags/spring-security">spring security</a>
           
      
          <a class="badge badge-tag" href="/tags/context">context</a>
          
      
    
    
    <br/>
    
        <i class="fas fa-clock"></i> length: 
    
</div>


  </header>
  
  
  <div class="post">
    <p>Welcome to the 8th iteration of WebCalc. <a href="/posts/webcalc-iteration-7-billing/">Previously</a>
 I promised to extract billing module from the app module and that&rsquo;s what I&rsquo;ll start with. To IDEs then.</p>
<p>There&rsquo;s nothing really fancy about extracting this module. You can see the <a href="https://github.com/jacekbilski/WebCalc/commit/9f191153ecf616318c041547a82ba0b9a709c3d3" target="_blank">full commit 9f191153</a>
, but it really boils down to creating a new module and copying <code>build.gradle</code> from calculator module, adding it to <code>settings.gradle</code>, moving <code>Billing</code> and <code>BillingShould</code> to the new module and importing new module in the app module.</p>
<p>I&rsquo;ll also do a few upgrades while I&rsquo;m more on the technical side of things and not dealing with business code. Gradle does seem old already so I&rsquo;m:</p>
<ol>
<li>installing it with <a href="https://sdkman.io/" target="_blank">SDKMAN</a>
</li>
<li>and calling <code>gradle wrapper --gradle-version=5.4.1 --distribution-type=all</code> in project&rsquo;s root directory.</li>
</ol>
<p>Results are in <a href="https://github.com/jacekbilski/WebCalc/commit/6cc51b7377e14846639204f1312b6caef78668bc" target="_blank">commit 6cc51b73</a>
</p>
<p>Tests are still green, so I can move on.</p>
<p>Next thing to upgrade is Spring Boot, the newest version seems to be 2.1.4, so:</p>


<span id="ae2d5a678e3b64d8c72d7c2e5acd71cd54c13893"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: build.gradle\n===================================================================\n--- build.gradle\n\x2b\x2b\x2b build.gradle\n@@ -1,6 \x2b1,6 @@\n buildscript {\n   ext {\n-    springBootVersion = \x222.1.1.RELEASE\x22\n\x2b    springBootVersion = \x222.1.4.RELEASE\x22\n   }\n   repositories {\n     mavenCentral()\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("ae2d5a678e3b64d8c72d7c2e5acd71cd54c13893").innerHTML = diffHtml;
</script>

<p>Tests keep being green, no matter what I throw at them. As there are no other things to upgrade I can go back to delivering something to my theoretical stakeholders. This time the idea is to take users into account when billing, so if user A executes some calculations, he&rsquo;s billed, but user B is not, logical.</p>
<p>Now there&rsquo;s probably no way for me to escape from having actual users, so I&rsquo;ll use what I&rsquo;ve configured Spring Security for back in <a href="/posts/webcalc-iteration-6-introducing-users/">iteration 6</a>
. As usual, I start with a test and I need to break two APIs, <code>Controller</code>'s and <code>Billing</code>'s by adding a user in there. This will force me to probably rewrite half of the application and I&rsquo;m just wondering if that could have been avoided.</p>


<span id="7b6f19e409d00f90cccd33447fe4457f53be2573"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -8,6 \x2b8,7 @@\n import org.junit.jupiter.params.provider.CsvSource;\n\n import java.math.BigDecimal;\n\x2bimport java.util.UUID;\n\n import static java.math.BigDecimal.ONE;\n import static java.math.BigDecimal.TEN;\n@@ -19,6 \x2b20,9 @@\n   private final Billing billing = new Billing();\n   private final Calculator calculator = new Calculator();\n\n\x2b  private UUID userA = UUID.randomUUID();\n\x2b  private UUID userB = UUID.randomUUID();\n\x2b\n   @BeforeEach\n   void setUp() {\n     calculator.addObserver(billing);\n@@ -82,4 \x2b86,11 @@\n     BigDecimal balance = billing.getBalance();\n     assertThat(balance).isEqualByComparingTo(expectedBalance);\n   }\n\x2b\n\x2b  @Test\n\x2b  void billOnlyUserA_whenAIsCalculating() {\n\x2b    calculator.eval(userA, \x221 2 \x2b\x22, 0);\n\x2b    assertThat(billing.getBalance(userA)).isEqualByComparingTo(ONE);\n\x2b    assertThat(billing.getBalance(userB)).isEqualByComparingTo(ZERO);\n\x2b  }\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("7b6f19e409d00f90cccd33447fe4457f53be2573").innerHTML = diffHtml;
</script>

<p>I&rsquo;m not exactly introducing user object, I&rsquo;ll see if just having IDs will be enough, I hope it will. As promised, this test breaks API horribly, so I need to fix both <code>Calculator</code> and <code>Billing</code> classes.</p>


<span id="1f9edf61f60ac6e331b26126e31bbd4780f26402"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -3,6 \x2b3,7 @@\n import com.webcalc.calculator.CalculatorObserver;\n\n import java.math.BigDecimal;\n\x2bimport java.util.UUID;\n\n import static java.math.BigDecimal.ONE;\n import static java.math.BigDecimal.TEN;\n@@ -12,7 \x2b13,7 @@\n\n   private BigDecimal balance = ZERO;\n\n-  public BigDecimal getBalance() {\n\x2b  public BigDecimal getBalance(UUID userId) {\n     return balance;\n   }\n\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -7,6 \x2b7,7 @@\n import java.text.ParseException;\n import java.util.Locale;\n import java.util.Stack;\n\x2bimport java.util.UUID;\n import java.util.function.BinaryOperator;\n\n public class Calculator {\n@@ -23,7 \x2b24,7 @@\n       ((DecimalFormat) formatter).setParseBigDecimal(true);\n   }\n\n-  public String eval(String input, int maxFractionDigits) {\n\x2b  public String eval(UUID userId, String input, int maxFractionDigits) {\n     String[] tokens = input.trim().split(\x22 \x22);\n     var stack = new Stack\x3cBigDecimal\x3e();\n     for (String token : tokens) {\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("1f9edf61f60ac6e331b26126e31bbd4780f26402").innerHTML = diffHtml;
</script>

<p>This, in turn, forces me to change both controllers and the rest of the tests. In controllers, I&rsquo;ll do a nasty thing and just pass in a <code>NULL</code>. For now, this will make the code compile and if some test will fail later on, I&rsquo;ll fix it.</p>


<span id="f628697f6be7336cafa1abd11b5207d21fe36e5b"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -14,6 \x2b14,6 @@\n\n   @GetMapping(\x22\/balance\x22)\n   public String getBalance() {\n-    return billing.getBalance().toPlainString();\n\x2b    return billing.getBalance(null).toPlainString();\n   }\n }\nIndex: app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n@@ -22,7 \x2b22,7 @@\n   public String calculate(@RequestBody String body, HttpSession session) {\n     if (session.getAttribute(MAX_FRACTION_DIGITS) == null)\n       session.setAttribute(MAX_FRACTION_DIGITS, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n-    return calculator.eval(body, (Integer) session.getAttribute(MAX_FRACTION_DIGITS));\n\x2b    return calculator.eval(null, body, (Integer) session.getAttribute(MAX_FRACTION_DIGITS));\n   }\n\n   @PutMapping(\x22\/maxFractionDigits\x22)\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("f628697f6be7336cafa1abd11b5207d21fe36e5b").innerHTML = diffHtml;
</script>

<p>In the tests, I need to create some user ids and just use them.</p>


<span id="15e5aeea8673d9ed580b184f67afaca5dbe366d1"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b billing\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -30,43 \x2b30,43 @@\n\n   @Test\n   void returnBalanceZero_whenNoCalculationsWereDone() {\n-    BigDecimal balance = billing.getBalance();\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(ZERO);\n   }\n\n   @Test\n   void returnBalanceOfOne_afterCalculatingOneAddition() {\n-    calculator.eval(\x221 2 \x2b\x22, 0);\n-    BigDecimal balance = billing.getBalance();\n\x2b    calculator.eval(userA, \x221 2 \x2b\x22, 0);\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(ONE);\n   }\n\n   @Test\n   void returnBalanceOfTwo_afterCalculatingTwoAdditions() {\n-    calculator.eval(\x221 2 \x2b\x22, 0);\n-    calculator.eval(\x221 2 \x2b\x22, 0);\n-    BigDecimal balance = billing.getBalance();\n\x2b    calculator.eval(userA, \x221 2 \x2b\x22, 0);\n\x2b    calculator.eval(userA, \x221 2 \x2b\x22, 0);\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(new BigDecimal(\x222\x22));\n   }\n\n   @Test\n   void returnBalanceOfFive_afterCalculatingOneMultiplication() {\n-    calculator.eval(\x223 2 *\x22, 0);\n-    BigDecimal balance = billing.getBalance();\n\x2b    calculator.eval(userA, \x223 2 *\x22, 0);\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(new BigDecimal(\x225\x22));\n   }\n\n   @Test\n   void returnBalanceOfOne_afterCalculatingOneSubtraction() {\n-    calculator.eval(\x223 3 -\x22, 0);\n-    BigDecimal balance = billing.getBalance();\n\x2b    calculator.eval(userA, \x223 3 -\x22, 0);\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(ONE);\n   }\n\n   @Test\n   void returnBalanceOfTen_afterCalculatingOneDivision() {\n-    calculator.eval(\x225 2.5 \/\x22, 2);\n-    BigDecimal balance = billing.getBalance();\n\x2b    calculator.eval(userA, \x225 2.5 \/\x22, 2);\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(TEN);\n   }\n\n@@ -81,9 \x2b81,9 @@\n   })\n   void complexBilling(String input, BigDecimal expectedBalance) {\n     for (String i : input.split(\x22;\x22)) {\n-      calculator.eval(i, 2);\n\x2b      calculator.eval(userA, i, 2);\n     }\n-    BigDecimal balance = billing.getBalance();\n\x2b    BigDecimal balance = billing.getBalance(userA);\n     assertThat(balance).isEqualByComparingTo(expectedBalance);\n   }\n\nIndex: calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n===================================================================\n--- calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n\x2b\x2b\x2b calculator\/src\/test\/java\/com\/webcalc\/calculator\/CalculatorShould.java\n@@ -4,12 \x2b4,16 @@\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.CsvSource;\n\n\x2bimport java.util.UUID;\n\x2b\n import static org.assertj.core.api.Assertions.assertThat;\n\n class CalculatorShould {\n\n   private final Calculator calculator = new Calculator();\n\n\x2b  private final UUID userId = UUID.randomUUID();\n\x2b\n   @DisplayName(\x22Sum\x22)\n   @ParameterizedTest(name = \x22input: \x27\x27{0}\x27\x27, expected result: \x27\x27{1}\x27\x27\x22)\n   @CsvSource({\n@@ -20,7 \x2b24,7 @@\n       \x22\x271,2 3,4 \x2b\x27, \x274,6\x27\x22,\n   })\n   void sum(String input, String expectedResult) {\n-    String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n\x2b    String result = calculator.eval(userId, input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n\n@@ -33,7 \x2b37,7 @@\n       \x22\x271,2 0,5 -\x27, \x270,7\x27\x22,\n   })\n   void subtract(String input, String expectedResult) {\n-    String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n\x2b    String result = calculator.eval(userId, input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n\n@@ -48,7 \x2b52,7 @@\n       \x22\x273,333 4,444 *\x27, \x2714,81\x27\x22,\n   })\n   void multiply(String input, String expectedResult) {\n-    String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n\x2b    String result = calculator.eval(userId, input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n\n@@ -63,7 \x2b67,7 @@\n       \x223 2 \/, 2, 0\x22,\n   })\n   void divide(String input, String expectedResult, int maxFractionDigits) {\n-    String result = calculator.eval(input, maxFractionDigits);\n\x2b    String result = calculator.eval(userId, input, maxFractionDigits);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n\n@@ -77,7 \x2b81,7 @@\n       \x221 2 \x2b 3 *, 9\x22,\n   })\n   void complexCalculations(String input, String expectedResult) {\n-    String result = calculator.eval(input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n\x2b    String result = calculator.eval(userId, input, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n     assertThat(result).isEqualTo(expectedResult);\n   }\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("15e5aeea8673d9ed580b184f67afaca5dbe366d1").innerHTML = diffHtml;
</script>

<p>By the way, all those refactorings are quite easy to do with a good IDE. Now everything compiles, tests are executed and all green except my new one. I can finally start working on making it green.</p>
<p>The second assertion in my test is failing, apparently user B was also billed for what user A did. No wonder, there&rsquo;s currently only a global balance, I need to change it to some map from user id to a balance. That also means, that <code>CalculatorObserver</code> would need to carry user information. Not an issue:</p>


<span id="19082bac83445a4fc6eae59e7807dc9377e8340f"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b billing\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -3,6 \x2b3,8 @@\n import com.webcalc.calculator.CalculatorObserver;\n\n import java.math.BigDecimal;\n\x2bimport java.util.HashMap;\n\x2bimport java.util.Map;\n import java.util.UUID;\n\n import static java.math.BigDecimal.ONE;\n@@ -11,24 \x2b13,25 @@\n\n public class Billing implements CalculatorObserver {\n\n-  private BigDecimal balance = ZERO;\n\x2b  private Map\x3cUUID, BigDecimal\x3e balance = new HashMap\x3c\x3e();\n\n   public BigDecimal getBalance(UUID userId) {\n-    return balance;\n\x2b    return balance.getOrDefault(userId, ZERO);\n   }\n\n   @Override\n-  public void evaluated(String function) {\n\x2b  public void evaluated(UUID userId, String function) {\n\x2b    balance.putIfAbsent(userId, ZERO);\n     switch (function) {\n       case \x22\x2b\x22:\n       case \x22-\x22:\n-        balance = balance.add(ONE);\n\x2b        balance.merge(userId, ONE, BigDecimal::add);\n         break;\n       case \x22*\x22:\n-        balance = balance.add(new BigDecimal(\x225\x22));\n\x2b        balance.merge(userId, new BigDecimal(\x225\x22), BigDecimal::add);\n         break;\n       case \x22\/\x22:\n-        balance = balance.add(TEN);\n\x2b        balance.merge(userId, TEN, BigDecimal::add);\n         break;\n     }\n   }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n@@ -1,5 \x2b1,7 @@\n package com.webcalc.calculator;\n\n\x2bimport java.util.UUID;\n\x2b\n public interface CalculatorObserver {\n-  void evaluated(String function);\n\x2b  void evaluated(UUID userId, String function);\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("19082bac83445a4fc6eae59e7807dc9377e8340f").innerHTML = diffHtml;
</script>

<p>One last thing, <code>Calculator</code> needs to pass <code>userId</code> to the observer call.</p>


<span id="351805e7caa3c6afe186ebc4824c74d587a59c03"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -37,7 \x2b37,7 @@\n         var b = stack.pop();\n         stack.push(f.apply(b, a));\n         if (observer != null)\n-          observer.evaluated(token);\n\x2b          observer.evaluated(userId, token);\n       }\n     }\n     return format(stack.pop(), maxFractionDigits);\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("351805e7caa3c6afe186ebc4824c74d587a59c03").innerHTML = diffHtml;
</script>

<p>I&rsquo;m done, all tests are now passing, phew. The mere amount of time I had to spend in red (having not passing tests) shows how still inexperienced I am when it comes to TDD. But we all need to learn constantly, maybe next time I would be able to avoid such a situation. Or maybe not because there&rsquo;s no other way. I&rsquo;ll see if I can get something out of this.</p>
<p>What bothers me now is that internally everything works, but I have those two <code>NULL</code>s in controllers. To actually fix those I need a very similar test, but working from outside, through the REST interface. And I&rsquo;m wondering right now why I do not have such test already. It seems I did the same mistake again, I started adding a feature not from outside, I assumed I know how to implement it properly. Anyway, the test:</p>


<span id="9b64c3924d5da958ec3b6aef6e15cd649edfbc4f"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n@@ -11,13 \x2b11,39 @@\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n class BillingApiShould {\n\n-  private static final String DEFAULT_USERNAME = \x22mmustermann\x22;\n-  private static final String DEFAULT_PASSWORD = \x229786f3gb4508c2393q7y\x22;\n\x2b  private static final String USER1_NAME = \x22mmustermann\x22;\n\x2b  private static final String USER1_PASS = \x229786f3gb4508c2393q7y\x22;\n\x2b\n\x2b  private static final String USER2_NAME = \x22user2_name\x22;\n\x2b  private static final String USER2_PASS = \x22user2_pass\x22;\n\n   @Test\n   void returnsZeroWhenNoCalculationsDone() {\n     given()\n-        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n\x2b        .auth().preemptive().basic(USER1_NAME, USER1_PASS)\n\x2b    .when()\n\x2b        .get(\x22\/balance\x22)\n\x2b    .then()\n\x2b        .body(equalTo(\x220\x22));\n\x2b  }\n\x2b\n\x2b  @Test\n\x2b  void chargeOnlyUser1_when1IsCalculating() {\n\x2b    given()\n\x2b        .auth().preemptive().basic(USER1_NAME, USER1_PASS)\n\x2b        .body(\x221 2 \x2b\x22)\n\x2b    .when()\n\x2b        .post(\x22\/eval\x22);\n\x2b\n\x2b    given()\n\x2b        .auth().preemptive().basic(USER1_NAME, USER1_PASS)\n\x2b    .when()\n\x2b        .get(\x22\/balance\x22)\n\x2b    .then()\n\x2b        .body(equalTo(\x221\x22));\n\x2b\n\x2b    given()\n\x2b        .auth().preemptive().basic(USER2_NAME, USER2_PASS)\n     .when()\n         .get(\x22\/balance\x22)\n     .then()\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("9b64c3924d5da958ec3b6aef6e15cd649edfbc4f").innerHTML = diffHtml;
</script>

<p>I also changed the constants for username and password, because now I need two of them. When I run it, already the first assertion fails, apparently I didn&rsquo;t even charge the correct user. Yes, now I need to fix the <code>NULL</code>s in both controllers.</p>
<p>It seems that I need a custom <code>UserDetailsService</code> and a custom <code>User</code> class. The reason is that I assumed that a user has an id and it is of <code>UUID</code> type. None of that is true with default Spring Boot configuration. This is getting bigger than I was hoping, but the only other choice I have is to revert those choices and I don&rsquo;t want to do that. It seems that I&rsquo;ll start growing some <code>Users</code> module, but as usual, I&rsquo;ll start adding code to the <code>app</code> module and will be extracting it later. Let&rsquo;s start with <code>User</code> class.</p>
<p>Because I&rsquo;m using Spring Security, I&rsquo;m forced to make my <code>User</code> class implement <code>UserDetails</code> interface or extend directly from <code>org.springframework.security.core.userdetails.User</code>. This is creating a tight coupling between my application and Spring Security which I don&rsquo;t like. But when I create my own <code>User</code> class, even if it&rsquo;s implementing Spring&rsquo;s interfaces, I might try to limit the damage. I&rsquo;ll use composition instead of inheritance, as all good practices suggest, and just delegate what&rsquo;s necessary. I could, if need be, remove Spring Security and reimplement its API, but changes to the implementation might not be that big. By the way, I&rsquo;m starting to get the idea of why working with Spring Security is not such an easy thing.</p>


<span id="646a91f0a99b555a6af01aee6d3ae7e4e5325d16"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/user\/User.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/user\/User.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/user\/User.java\n@@ -0,0 \x2b1,58 @@\n\x2bpackage com.webcalc.user;\n\x2b\n\x2bimport org.springframework.security.core.GrantedAuthority;\n\x2bimport org.springframework.security.core.userdetails.UserDetails;\n\x2b\n\x2bimport java.util.Collection;\n\x2bimport java.util.UUID;\n\x2b\n\x2bpublic class User implements UserDetails {\n\x2b\n\x2b  public final UUID id;\n\x2b\n\x2b  private final UserDetails springSecUser;\n\x2b\n\x2b  public User(UUID id, String username, String password) {\n\x2b    this.id = id;\n\x2b    springSecUser = org.springframework.security.core.userdetails.User.builder()\n\x2b        .username(username)\n\x2b        .password(password)\n\x2b        .roles()\n\x2b        .build();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public Collection\x3c? extends GrantedAuthority\x3e getAuthorities() {\n\x2b    return springSecUser.getAuthorities();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public String getPassword() {\n\x2b    return springSecUser.getPassword();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public String getUsername() {\n\x2b    return springSecUser.getUsername();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public boolean isAccountNonExpired() {\n\x2b    return springSecUser.isAccountNonExpired();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public boolean isAccountNonLocked() {\n\x2b    return springSecUser.isAccountNonLocked();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public boolean isCredentialsNonExpired() {\n\x2b    return springSecUser.isCredentialsNonExpired();\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public boolean isEnabled() {\n\x2b    return springSecUser.isEnabled();\n\x2b  }\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("646a91f0a99b555a6af01aee6d3ae7e4e5325d16").innerHTML = diffHtml;
</script>

<p>OK, <code>User</code> is not enough, I also need my own <code>UserDetailsService</code>:</p>


<span id="bf2cf30ac0f4f968de3358cc4027f7851f922855"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n@@ -0,0 \x2b1,25 @@\n\x2bpackage com.webcalc.user;\n\x2b\n\x2bimport org.springframework.security.core.userdetails.UserDetails;\n\x2bimport org.springframework.security.core.userdetails.UserDetailsService;\n\x2bimport org.springframework.security.core.userdetails.UsernameNotFoundException;\n\x2b\n\x2bimport java.util.HashMap;\n\x2bimport java.util.Map;\n\x2bimport java.util.UUID;\n\x2b\n\x2bpublic class WebCalcUserDetailsService implements UserDetailsService {\n\x2b\n\x2b  private static final Map\x3cString, User\x3e users = new HashMap\x3c\x3e();\n\x2b\n\x2b  static {\n\x2b    users.put(\x22mmustermann\x22, new User(UUID.randomUUID(), \x22mmustermann\x22, \x229786f3gb4508c2393q7y\x22));\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n\x2b    if (users.containsKey(username))\n\x2b      return users.get(username);\n\x2b    throw new UsernameNotFoundException(\x22User unknown\x22);\n\x2b  }\n\x2b}\nIndex: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -2,6 \x2b2,7 @@\n\n import com.webcalc.billing.Billing;\n import com.webcalc.calculator.Calculator;\n\x2bimport com.webcalc.user.WebCalcUserDetailsService;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.context.annotation.Bean;\n@@ -9,6 \x2b10,7 @@\n import org.springframework.context.annotation.Configuration;\n import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\x2bimport org.springframework.security.core.userdetails.UserDetailsService;\n\n @SpringBootApplication\n @ComponentScan(\x22com.webcalc\x22)\n@@ -28,6 \x2b30,11 @@\n     return new Billing();\n   }\n\n\x2b  @Bean\n\x2b  public UserDetailsService userDetailsService() {\n\x2b    return new WebCalcUserDetailsService();\n\x2b  }\n\x2b\n   @Configuration\n   protected static class ApplicationSecurity extends WebSecurityConfigurerAdapter {\n\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("bf2cf30ac0f4f968de3358cc4027f7851f922855").innerHTML = diffHtml;
</script>

<p>It contains only one user with the same username and password as previously. I also wired it up, so I should be in exactly the same place as before, let&rsquo;s run the tests to see if I&rsquo;m not lying.</p>
<p>I&rsquo;m a liar, the error I&rsquo;m getting now is <code>There is no PasswordEncoder mapped for the id &quot;null&quot;</code>. That&rsquo;s unexpected. A quick check on the Internet and I know I need to specify the password as <code>{noop}9786f3gb4508c2393q7y</code>, see <a href="https://spring.io/blog/2017/11/01/spring-security-5-0-0-rc1-released#password-storage-format" target="_blank">here</a>
. The fix is simple:</p>


<span id="73e5da543308a41c02f586d31d884fbcfd297354"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n@@ -13,7 \x2b13,7 @@\n   private static final Map\x3cString, User\x3e users = new HashMap\x3c\x3e();\n\n   static {\n-    users.put(\x22mmustermann\x22, new User(UUID.randomUUID(), \x22mmustermann\x22, \x229786f3gb4508c2393q7y\x22));\n\x2b    users.put(\x22mmustermann\x22, new User(UUID.randomUUID(), \x22mmustermann\x22, \x22{noop}9786f3gb4508c2393q7y\x22));\n   }\n\n   @Override\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("73e5da543308a41c02f586d31d884fbcfd297354").innerHTML = diffHtml;
</script>

<p>Now I also don&rsquo;t need default user configured in <code>application.yaml</code> file.</p>


<span id="9d8b66696cadea90a55c5a8de0498b76cb7d32a7"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/resources\/application.yaml\n===================================================================\n--- app\/src\/test\/resources\/application.yaml\n\x2b\x2b\x2b app\/src\/test\/resources\/application.yaml\n@@ -1,3 \x2b0,0 @@\n-spring.security.user:\n-  name: mmustermann\n-  password: 9786f3gb4508c2393q7y\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("9d8b66696cadea90a55c5a8de0498b76cb7d32a7").innerHTML = diffHtml;
</script>

<p>OK, now I&rsquo;m in a position I wanted to be, all tests are green apart from my newly created one. But it is actually wrong, I should be already charging someone for doing any calculations, my new tests is only verifying that I&rsquo;m not charging the wrong users. That&rsquo;s how I end up missing important business logic by not writing proper tests. I wrote the tests for my <code>Calculator</code> class but didn&rsquo;t do that for my REST API part. And I thought I&rsquo;m doing TDD&hellip;</p>
<p>I&rsquo;m adding a new REST API test, even before the currently red one, just to verify someone was charged. It&rsquo;s actually a partial copy of this new test:</p>


<span id="0b562ac57ccaec6c6a4be9472113ceb7ebd242dc"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n@@ -27,6 \x2b27,22 @@\n         .body(equalTo(\x220\x22));\n   }\n\n\x2b  @Test\n\x2b  void chargeUser1_when1IsCalculating() {\n\x2b    given()\n\x2b        .auth().preemptive().basic(USER1_NAME, USER1_PASS)\n\x2b        .body(\x221 2 \x2b\x22)\n\x2b    .when()\n\x2b        .post(\x22\/eval\x22);\n\x2b\n\x2b    given()\n\x2b        .auth().preemptive().basic(USER1_NAME, USER1_PASS)\n\x2b    .when()\n\x2b        .get(\x22\/balance\x22)\n\x2b    .then()\n\x2b        .body(equalTo(\x221\x22));\n\x2b  }\n\x2b\n   @Test\n   void chargeOnlyUser1_when1IsCalculating() {\n     given()\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("0b562ac57ccaec6c6a4be9472113ceb7ebd242dc").innerHTML = diffHtml;
</script>

<p>The fact that it is a partial copy suggests to me that there&rsquo;s some duplication in the tests, maybe they&rsquo;re not testing the right things, I&rsquo;ll look into it is a minute. For now, I&rsquo;m focusing on the test I just wrote. Luckily, it&rsquo;s red so I need to fix it.</p>
<p>After inspecting the code a bit, to my surprise, I find out that on the application or Spring level I&rsquo;m not injecting <code>Billing</code> as an observer to <code>Calculator</code>. This is getting more and more embarrassing for me&hellip; Luckily, the fix is quite simple:</p>


<span id="63e308c391b6e9765f94e0ff36a20338b6b33047"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -26,8 \x2b26,10 @@\n   }\n\n   @Bean\n-  public Billing billing() {\n-    return new Billing();\n\x2b  public Billing billing(Calculator calculator) {\n\x2b    Billing billing = new Billing();\n\x2b    calculator.addObserver(billing);\n\x2b    return billing;\n   }\n\n   @Bean\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("63e308c391b6e9765f94e0ff36a20338b6b33047").innerHTML = diffHtml;
</script>

<p>Now things get more interesting because all my tests for billing going through the REST interface became red. The reason is simple and terrifying - the state from one test is carried over to the next test. Of course, the <code>Map</code> I have in <code>Billing</code> is not cleaned up between the tests so it carries over current balance. This is actually a good thing, in the real world I want that! In the tests though that&rsquo;s a very bad thing. As I&rsquo;m using Spring, there&rsquo;s an annotation created for such situations, <code>@DirtiesContext</code>. As each of my tests assumes a clean state, I&rsquo;ll use <code>BEFORE_EACH_TEST_METHOD</code> mode, like so:</p>


<span id="f166e52d1417ded5d8bdd7e51b7cfe35865b7950"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n@@ -3,12 \x2b3,14 @@\n import com.webcalc.app.WebCalcApplication;\n import org.junit.jupiter.api.Test;\n import org.springframework.boot.test.context.SpringBootTest;\n\x2bimport org.springframework.test.annotation.DirtiesContext;\n\n import static io.restassured.RestAssured.given;\n import static org.hamcrest.Matchers.equalTo;\n\n @SpringBootTest(classes = WebCalcApplication.class,\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n\x2b@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)\n class BillingApiShould {\n\n   private static final String USER1_NAME = \x22mmustermann\x22;\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("f166e52d1417ded5d8bdd7e51b7cfe35865b7950").innerHTML = diffHtml;
</script>

<p>I was expecting only one of my billing tests to turn green, but two of them stopped failing. The reason is, I can use a <code>NULL</code> as a key to a <code>Map</code> in <code>Billing</code> that contains balance of each user. As I&rsquo;m passing in a <code>NULL</code> as a <code>userId</code>, my current implementation works. Not expected, but also not bad either.</p>
<p>OK, I finally managed to get the whole application to a state where it should have been before I started this iteration, better late than never. I can finally try to do something with my last failing test. It&rsquo;s red because I&rsquo;m not differentiating users in any way beyond controllers, <code>userId</code> is always <code>NULL</code>. I need to get the user in both controllers, in Spring Security world it is done like so:</p>


<span id="debbfa7577acfc28c5f29e9e970d246f754a7636"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -1,8 \x2b1,12 @@\n package com.webcalc.billing;\n\n\x2bimport com.webcalc.user.User;\n\x2bimport org.springframework.security.core.Authentication;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.RestController;\n\n\x2bimport javax.servlet.http.HttpServletRequest;\n\x2b\n @RestController\n public class BillingController {\n\n@@ -13,7 \x2b17,8 @@\n   }\n\n   @GetMapping(\x22\/balance\x22)\n-  public String getBalance() {\n-    return billing.getBalance(null).toPlainString();\n\x2b  public String getBalance(HttpServletRequest request) {\n\x2b    Authentication auth = (Authentication) request.getUserPrincipal();\n\x2b    return billing.getBalance(((User) auth.getPrincipal()).id).toPlainString();\n   }\n }\nIndex: app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorController.java\n@@ -1,10 \x2b1,13 @@\n package com.webcalc.calculator;\n\n\x2bimport com.webcalc.user.User;\n\x2bimport org.springframework.security.core.Authentication;\n import org.springframework.web.bind.annotation.PostMapping;\n import org.springframework.web.bind.annotation.PutMapping;\n import org.springframework.web.bind.annotation.RequestBody;\n import org.springframework.web.bind.annotation.RestController;\n\n\x2bimport javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpSession;\n\n @RestController\n@@ -19,10 \x2b22,11 @@\n   }\n\n   @PostMapping(\x22\/eval\x22)\n-  public String calculate(@RequestBody String body, HttpSession session) {\n\x2b  public String calculate(@RequestBody String body, HttpSession session, HttpServletRequest request) {\n     if (session.getAttribute(MAX_FRACTION_DIGITS) == null)\n       session.setAttribute(MAX_FRACTION_DIGITS, Calculator.DEFAULT_MAX_FRACTION_DIGITS);\n-    return calculator.eval(null, body, (Integer) session.getAttribute(MAX_FRACTION_DIGITS));\n\x2b    Authentication auth = (Authentication) request.getUserPrincipal();\n\x2b    return calculator.eval(((User) auth.getPrincipal()).id, body, (Integer) session.getAttribute(MAX_FRACTION_DIGITS));\n   }\n\n   @PutMapping(\x22\/maxFractionDigits\x22)\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("debbfa7577acfc28c5f29e9e970d246f754a7636").innerHTML = diffHtml;
</script>

<p>Interestingly enough that doesn&rsquo;t fix my test, but after taking a closer look I noticed that I simply lack a second user. The fix is easy:</p>


<span id="00edd2498fe3a50d6970c048a79860bcf5b3e391"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/user\/WebCalcUserDetailsService.java\n@@ -14,6 \x2b14,7 @@\n\n   static {\n     users.put(\x22mmustermann\x22, new User(UUID.randomUUID(), \x22mmustermann\x22, \x22{noop}9786f3gb4508c2393q7y\x22));\n\x2b    users.put(\x22user2_name\x22, new User(UUID.randomUUID(), \x22user2_name\x22, \x22{noop}user2_pass\x22));\n   }\n\n   @Override\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("00edd2498fe3a50d6970c048a79860bcf5b3e391").innerHTML = diffHtml;
</script>

<p>Finally! All tests green!</p>
<p>I must admit that this iteration was a very challenging and frustrating one. And it was only my fault. Most of the problems were coming from my previous mistakes, the iteration was far bigger than it should have been, I had to add a test and complete missing implementation, and all that in the middle of working on something else. I was thinking several times about rewriting the iteration completely, fixing things first and then moving onto the actual thing I wanted to do. But again, this whole series is about learning. This iteration clearly shows how much trouble I got myself into just by forgetting testing things from outside and, in the end, missing important pieces of implementation. Plus, by actually going through all the pain, maybe I&rsquo;ll remember it better.</p>
<p>Anyway, thanks for bearing with me. In the next iteration&hellip; I have no clue what I&rsquo;ll be doing. Let it be a surprise for all of us. See you next time!</p>

  </div>
  


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="jacekbilski/jacekbilski.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
