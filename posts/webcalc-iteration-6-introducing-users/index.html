<!DOCTYPE html>
<html lang="en-gb">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="Jacek Bilski">
<meta name="generator" content="Hugo 0.58.3" />

    
    
    

<title>WebCalc iteration 6 - introducing users • On Software Engineering</title>
<meta name="description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project.">
<meta name="keywords" content="JUnit 5, testing, tests, TDD">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="WebCalc iteration 6 - introducing users"/>
<meta name="twitter:description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project."/>
<meta name="twitter:site" content="@jacek_bilski"/>

<meta property="og:title" content="WebCalc iteration 6 - introducing users" />
<meta property="og:description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.bilski.tech/posts/webcalc-iteration-6-introducing-users/" />
<meta property="article:published_time" content="2019-03-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-03-28T00:00:00+00:00" />


    






<link rel="stylesheet" href="/scss/hyde-hyde.d8e474f8dcee7b234bc8afe1479c3b44440642d23eebbb8b4977250a46484d42.css" integrity="sha256-2OR0&#43;NzueyNLyK/hR5w7REQGQtI&#43;67uLSXclCkZITUI=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    
<link href='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.css' rel='stylesheet' type='text/css'/>
<style type='text/css'>
.d2h-wrapper {
    color: black;
    background: white;
    line-height: normal;
}
.d2h-wrapper td {
    padding: 0;
    border: none;
}
.d2h-wrapper table {
    margin-bottom: 0;
}
.d2h-file-diff {
    overflow-x: auto;
}
</style>
<script src='https://cdnjs.cloudflare.com/ajax/libs/diff2html/2.7.0/diff2html.min.js' type='text/javascript'></script>


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.bilski.tech/">On Software Engineering</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://www.bilski.tech/img/jacek.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Jacek Bilski&#39;s thoughts about software engineering and how to improve it 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">On Software Engineering</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jacek_bilski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/jacekbilski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/jacek-bilski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://www.xing.com/profile/Jacek_Bilski3" rel="me"><i class="fab fa-xing fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>WebCalc iteration 6 - introducing users</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 28, 2019<br/>
    
    <i class="fas fa-user-edit"></i> Jacek Bilski
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/junit-5">junit 5</a>
           
      
          <a class="badge badge-tag" href="/tags/testing">testing</a>
           
      
          <a class="badge badge-tag" href="/tags/tests">tests</a>
           
      
          <a class="badge badge-tag" href="/tags/tdd">tdd</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 14 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Welcome to the 6th iteration of WebCalc. <a href="/posts/webcalc-iteration-5-more-complex-calculations/" target="_blank">Previously</a> I was dealing mostly with adding some more complex calculations. Like I mentioned there already, I think that I have already enough business logic to start moving into other areas like billing or user management. I also said that I&rsquo;d be going into the unknown. Up until now, I had a rough idea of how to do things, now I don&rsquo;t, I&rsquo;ll be exploring a lot.</p>

<p>Ultimately I want the application to bill the users, every operation should cost them some money and at the end of a month, an invoice will be prepared. Writing such a test now would make me work in red for days. I think, that the simplest test now would be to disallow anonymous users from doing any calculations, only logged in users can do something. That means, that I need to actually change my integration tests and add some test user there plus write a test that verifies that the system refuses to work without being logged in first.</p>

<p>There are many ways how users can authenticate themselves, but to keep things simple I&rsquo;d go for Basic Authentication. All those OAuth, OpenID or X509 are maybe more secure, can do more, but all that comes with much higher complexity. Long story short, username and password would need to be transferred on every request. That means that I also don&rsquo;t need any logging in functionality or page. That would also mean that I should be using HTTPS only.</p>

<p>My new test will be very simple, I&rsquo;ll just do the call without providing any authentication data and I&rsquo;ll expect to get HTTP 401 in return, like so:</p>



<span id="c57ae0441455a77bffc5cd252ce1b84e369ec115"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -42,6 \x2b42,16 @@\n     assertEvalResult(\x221 2 3 \x2b \x2b\x22, \x226\x22);\n   }\n\n\x2b  @Test\n\x2b  void anonymousUsersCannotPerformCalculations() {\n\x2b    given()\n\x2b        .body(\x221 2 \x2b\x22)\n\x2b    .when()\n\x2b        .post(\x22\/eval\x22)\n\x2b    .then()\n\x2b        .statusCode(401);\n\x2b  }\n\x2b\n   private void setMaxFractionDigitsForSession(int maxFractionDigits, SessionFilter session) {\n     given()\n         .filter(session)\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("c57ae0441455a77bffc5cd252ce1b84e369ec115").innerHTML = diffHtml;
</script>


<p>It fails because the HTTP status is still 200. I will already fix other tests to provide authentication data:</p>



<span id="170e0753cd2f1867bda41d8b373244ece74c9bbe"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -12,6 \x2b12,9 @@\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n class RestApiTest {\n\n\x2b  private static final String DEFAULT_USERNAME = \x22mmustermann\x22;\n\x2b  private static final String DEFAULT_PASSWORD = \x229786f3gb4508c2393q7y\x22;\n\x2b\n   @Test\n   void invokesWebCalcRestApi() {\n     assertEvalResult(\x221 2 \x2b\x22, \x223\x22);\n@@ -55,6 \x2b58,7 @@\n   private void setMaxFractionDigitsForSession(int maxFractionDigits, SessionFilter session) {\n     given()\n         .filter(session)\n\x2b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n         .body(maxFractionDigits)\n     .when()\n         .put(\x22\/maxFractionDigits\x22)\n@@ -69,6 \x2b73,7 @@\n   private void assertEvalResultForSession(String expression, String expectedResult, SessionFilter session) {\n     given()\n         .filter(session)\n\x2b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n         .body(expression)\n     .when()\n         .post(\x22\/eval\x22)\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("170e0753cd2f1867bda41d8b373244ece74c9bbe").innerHTML = diffHtml;
</script>


<p>Time to include Spring Security in the project:</p>



<span id="dee9f4d8461b0053678dac72b7aba5755f82eee6"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/build.gradle\n===================================================================\n--- app\/build.gradle\n\x2b\x2b\x2b app\/build.gradle\n@@ -9,6 \x2b9,7 @@\n dependencies {\n   implementation(project(\x22:calculator\x22))\n   implementation(\x22org.springframework.boot:spring-boot-starter-web\x22)\n\x2b  implementation(\x22org.springframework.boot:spring-boot-starter-security\x22)\n   testImplementation(\x22org.springframework.boot:spring-boot-starter-test\x22) {\n     exclude group: \x22junit\x22, module: \x22junit\x22\n   }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("dee9f4d8461b0053678dac72b7aba5755f82eee6").innerHTML = diffHtml;
</script>


<p>Apparently, Spring Boot does most of the stuff for me the moment it sees Spring Security JAR on the classpath. My new test is already passing, all others are red. To get them working I need to do a few things. First, I need to &ldquo;add&rdquo; a default user to Spring Security&rsquo;s UserDetailsService:</p>



<span id="a9c2cef6b7d4b71883ddab52503a6ee4361947b8"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/resources\/application.yaml\n===================================================================\n--- app\/src\/test\/resources\/application.yaml\n\x2b\x2b\x2b app\/src\/test\/resources\/application.yaml\n@@ -0,0 \x2b1,3 @@\n\x2bspring.security.user:\n\x2b  name: mmustermann\n\x2b  password: 9786f3gb4508c2393q7y\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("a9c2cef6b7d4b71883ddab52503a6ee4361947b8").innerHTML = diffHtml;
</script>


<p>I also need to configure the security a little. By default, Spring requires a correct CSRF token, but with basic auth only that doesn&rsquo;t make much sense:</p>



<span id="0a0c67b20722a496db75b89e79d27b5876fe9977"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -5,6 \x2b5,9 @@\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.ComponentScan;\n\x2bimport org.springframework.context.annotation.Configuration;\n\x2bimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\n\x2bimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\n @SpringBootApplication\n @ComponentScan(\x22com.webcalc\x22)\n@@ -18,4 \x2b21,16 @@\n   public Calculator calculator() {\n     return new Calculator();\n   }\n\x2b\n\x2b  @Configuration\n\x2b  protected static class ApplicationSecurity extends WebSecurityConfigurerAdapter {\n\x2b\n\x2b    @Override\n\x2b    protected void configure(HttpSecurity http) throws Exception {\n\x2b      http.authorizeRequests()\n\x2b          .anyRequest().fullyAuthenticated()\n\x2b          .and().httpBasic()\n\x2b          .and().csrf().disable();\n\x2b    }\n\x2b  }\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("0a0c67b20722a496db75b89e79d27b5876fe9977").innerHTML = diffHtml;
</script>


<p>Now all my tests are once again green. So far so good, three small steps and I get my application secured. Sure, I only have one user and I&rsquo;m not using HTTPS, so those things will require additional effort, but still. Can I unit test the thing that I just did? Unfortunately, it doesn&rsquo;t seem possible and that&rsquo;s making me feel uneasy, but let&rsquo;s see how all this unfolds.</p>

<p>I don&rsquo;t see the need right now to go deeper into user management or creating different users. All that would only be necessary once I start billing them for using the system. And that is, honestly, the only reason I can think of right now why I need any authorization anyway. So let&rsquo;s go there. The idea is pretty simple, for every operation there&rsquo;s a price, so after each calculation is done I&rsquo;ll be adding its cost to the user&rsquo;s bill. Of course, different functions will have different prices and each usage of a function will be charged, for example for calculating <code>1+2+3</code> you&rsquo;d be charged twice for using sum.</p>

<p>One of the most interesting features for the users would be checking their current balance. I&rsquo;ll not surprise anybody by exposing this via REST. This would also give me a possibility to verify later on charging proper users with correct amounts. This requires a new endpoint because it&rsquo;s something else than calculations. It doesn&rsquo;t belong to the app module, it should get its own eventually, but let&rsquo;s start simple, I&rsquo;ll extract it later. A test will look something like this:</p>



<span id="17e43d031cdab1282037344fabd5bbd9e62798e9"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n@@ -0,0 \x2b1,26 @@\n\x2bpackage com.webcalc.integration_tests;\n\x2b\n\x2bimport com.webcalc.app.WebCalcApplication;\n\x2bimport org.junit.jupiter.api.Test;\n\x2bimport org.springframework.boot.test.context.SpringBootTest;\n\x2b\n\x2bimport static io.restassured.RestAssured.given;\n\x2bimport static org.hamcrest.Matchers.equalTo;\n\x2b\n\x2b@SpringBootTest(classes = WebCalcApplication.class,\n\x2b    webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n\x2bclass BillingApiShould {\n\x2b\n\x2b  private static final String DEFAULT_USERNAME = \x22mmustermann\x22;\n\x2b  private static final String DEFAULT_PASSWORD = \x229786f3gb4508c2393q7y\x22;\n\x2b\n\x2b  @Test\n\x2b  void returnsZeroWhenNoCalculationsDone() {\n\x2b    given()\n\x2b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n\x2b    .when()\n\x2b        .get(\x22\/balance\x22)\n\x2b    .then()\n\x2b        .body(equalTo(\x220\x22));\n\x2b  }\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("17e43d031cdab1282037344fabd5bbd9e62798e9").innerHTML = diffHtml;
</script>


<p>The first thing that I&rsquo;ve noticed was inconsistent naming for test classes. I&rsquo;m still not sure if it&rsquo;s a blessing or a curse. On one hand, such inconsistencies affect readability or understandability of the code and, in effect, lead to errors in the code. On the other hand, going for nothing less than perfection is most likely not helping me deliver business value. In this case, it&rsquo;s a few renames, so let&rsquo;s do it. <code>RestApiTest</code> class will now be known as <code>CalculatorRestApiShould</code>. The idea with test classes ending with <code>should</code> is that when you read class name together with method names inside, they <a href="/posts/testing-is-storytelling/" target="_blank">tell &ldquo;a story&rdquo;</a>. I&rsquo;ve learned it from <a href="https://twitter.com/sandromancuso" target="_blank">Sandro Mancuso</a> and it does make sense. <code>CaclulatorShould</code> is already following this concept, <code>CalculatorRestApiShould</code> not yet, so:</p>



<span id="b830693ad60975f9b252ad0577778450b3870370"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/integration_tests\/CalculatorRestApiShould.java\n@@ -10,25 \x2b10,25 @@\n\n @SpringBootTest(classes = WebCalcApplication.class,\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n-class RestApiTest {\n\x2bclass CalculatorRestApiShould {\n\n   private static final String DEFAULT_USERNAME = \x22mmustermann\x22;\n   private static final String DEFAULT_PASSWORD = \x229786f3gb4508c2393q7y\x22;\n\n   @Test\n-  void invokesWebCalcRestApi() {\n\x2b  void returnResult() {\n     assertEvalResult(\x221 2 \x2b\x22, \x223\x22);\n   }\n\n   @Test\n-  void settingMaxFractionDigits() {\n\x2b  void setMaxFractionDigits() {\n     SessionFilter session = new SessionFilter();\n     setMaxFractionDigitsForSession(5, session);\n     assertEvalResultForSession(\x228 7 \/\x22, \x221,14286\x22, session);\n   }\n\n   @Test\n-  void maxFractionDigitsAffectsOnlyCurrentSession() {\n\x2b  void setMaxFractionDigitsOnlyForCurrentSession() {\n     SessionFilter session1 = new SessionFilter();\n     SessionFilter session2 = new SessionFilter();\n     String expression = \x228 7 \/\x22;\n@@ -41,12 \x2b41,12 @@\n   }\n\n   @Test\n-  void canDoComplexCalculations() {\n\x2b  void doComplexCalculations() {\n     assertEvalResult(\x221 2 3 \x2b \x2b\x22, \x226\x22);\n   }\n\n   @Test\n-  void anonymousUsersCannotPerformCalculations() {\n\x2b  void preventAnonymousUsersFromPerformingCalculations() {\n     given()\n         .body(\x221 2 \x2b\x22)\n     .when()\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("b830693ad60975f9b252ad0577778450b3870370").innerHTML = diffHtml;
</script>


<p>Back to the new API. The test is obviously red because I don&rsquo;t have the controller yet. That&rsquo;s easy to fix:</p>



<span id="a448867f2acbd62da5084a2e29cf8b799edbadee"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -0,0 \x2b1,13 @@\n\x2bpackage com.webcalc.billing;\n\x2b\n\x2bimport org.springframework.web.bind.annotation.GetMapping;\n\x2bimport org.springframework.web.bind.annotation.RestController;\n\x2b\n\x2b@RestController\n\x2bpublic class BillingController {\n\x2b\n\x2b  @GetMapping(\x22\/balance\x22)\n\x2b  public String getBalance() {\n\x2b    return \x220\x22;\n\x2b  }\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("a448867f2acbd62da5084a2e29cf8b799edbadee").innerHTML = diffHtml;
</script>


<p>I should now push returning <code>0</code> down to some kind of service, for example:</p>



<span id="bb49647534e02c1ef43e9d4d4b498936ba0e7e25"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -1,5 \x2b1,6 @@\n package com.webcalc.app;\n\n\x2bimport com.webcalc.billing.Billing;\n import com.webcalc.calculator.Calculator;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n@@ -22,6 \x2b23,11 @@\n     return new Calculator();\n   }\n\n\x2b  @Bean\n\x2b  public Billing billing() {\n\x2b    return new Billing();\n\x2b  }\n\x2b\n   @Configuration\n   protected static class ApplicationSecurity extends WebSecurityConfigurerAdapter {\n\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -0,0 \x2b1,10 @@\n\x2bpackage com.webcalc.billing;\n\x2b\n\x2bimport java.math.BigDecimal;\n\x2b\n\x2bpublic class Billing {\n\x2b\n\x2b  public BigDecimal getBalance() {\n\x2b    return BigDecimal.ZERO;\n\x2b  }\n\x2b}\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -6,8 \x2b6,14 @@\n @RestController\n public class BillingController {\n\n\x2b  private final Billing billing;\n\x2b\n\x2b  public BillingController(Billing billing) {\n\x2b    this.billing = billing;\n\x2b  }\n\x2b\n   @GetMapping(\x22\/balance\x22)\n   public String getBalance() {\n-    return \x220\x22;\n\x2b    return billing.getBalance().toPlainString();\n   }\n }\nIndex: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -0,0 \x2b1,19 @@\n\x2bpackage com.webcalc.billing;\n\x2b\n\x2bimport org.junit.jupiter.api.Test;\n\x2b\n\x2bimport java.math.BigDecimal;\n\x2b\n\x2bimport static java.math.BigDecimal.ZERO;\n\x2bimport static org.assertj.core.api.Assertions.assertThat;\n\x2b\n\x2bclass BillingShould {\n\x2b\n\x2b  private final Billing billing = new Billing();\n\x2b\n\x2b  @Test\n\x2b  void returnBalanceZero_whenNoCalculationsWereDone() {\n\x2b    BigDecimal balance = billing.getBalance();\n\x2b    assertThat(balance).isEqualByComparingTo(ZERO);\n\x2b  }\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("bb49647534e02c1ef43e9d4d4b498936ba0e7e25").innerHTML = diffHtml;
</script>


<p>Now things get much more interesting. Next logical step is to define a price for a function, execute a calculation using this function and see, that the balance increased. I&rsquo;ll still blissfully ignore the existence of different users. I can also still get away with not persisting anything &ldquo;for real&rdquo;. The tricky part is, that I want the calculator to be completely unaffected by billing, the module should not depend on the billing module. Obviously, billing would need to depend on the calculator. I can quite easily achieve this with a <a href="https://en.wikipedia.org/wiki/Decorator_pattern" target="_blank">decorator pattern</a>. But before I go in there, I need a test:</p>



<span id="e617f2b3a4fd97416b72cc0f7cf40d22e8110ad9"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -4,6 \x2b4,7 @@\n\n import java.math.BigDecimal;\n\n\x2bimport static java.math.BigDecimal.ONE;\n import static java.math.BigDecimal.ZERO;\n import static org.assertj.core.api.Assertions.assertThat;\n\n@@ -16,4 \x2b17,11 @@\n     BigDecimal balance = billing.getBalance();\n     assertThat(balance).isEqualByComparingTo(ZERO);\n   }\n\x2b\n\x2b  @Test\n\x2b  void returnBalanceOfOne_afterCalculatingOneSum() {\n\x2b    calculator.eval(\x221 2 \x2b\x22, 0);\n\x2b    BigDecimal balance = billing.getBalance();\n\x2b    assertThat(balance).isEqualByComparingTo(ONE);\n\x2b  }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -21,7 \x2b21,7 @@\n       ((DecimalFormat) formatter).setParseBigDecimal(true);\n   }\n\n-  String eval(String input, int maxFractionDigits) {\n\x2b  public String eval(String input, int maxFractionDigits) {\n     String[] tokens = input.split(\x22 \x22);\n     var stack = new Stack\x3cBigDecimal\x3e();\n     for (String token : tokens) {\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("e617f2b3a4fd97416b72cc0f7cf40d22e8110ad9").innerHTML = diffHtml;
</script>


<p>Looks simple enough, but I don&rsquo;t have <code>calculator</code>. I need to create a <code>BillingCalculator</code>, that will be a decorator of a &ldquo;real&rdquo; calculator, it will look like this:</p>



<span id="24d48b36ffdf86fdc9216360f3c0f4037318a477"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n@@ -0,0 \x2b1,17 @@\n\x2bpackage com.webcalc.billing;\n\x2b\n\x2bimport com.webcalc.calculator.Calculator;\n\x2b\n\x2bpublic class BillingCalculator extends Calculator {\n\x2b\n\x2b  private final Calculator target;\n\x2b\n\x2b  public BillingCalculator(Calculator target) {\n\x2b    this.target = target;\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public String eval(String input, int maxFractionDigits) {\n\x2b    return target.eval(input, maxFractionDigits);\n\x2b  }\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("24d48b36ffdf86fdc9216360f3c0f4037318a477").innerHTML = diffHtml;
</script>


<p>For now the only thing it can is to delegate a call to another calculator that was passed into it. This other calculator might be an actual calculator, the one I&rsquo;ve been writing so far, but it could also be a mock or anything else that can behave like a calculator. I&rsquo;ll go yet again simple and use the real one. The fixed test looks like this:</p>



<span id="3b5827e5830cc1b4d2153a1499b35277f01578c3"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -1,5 \x2b1,6 @@\n package com.webcalc.billing;\n\n\x2bimport com.webcalc.calculator.Calculator;\n import org.junit.jupiter.api.Test;\n\n import java.math.BigDecimal;\n@@ -11,6 \x2b12,7 @@\n class BillingShould {\n\n   private final Billing billing = new Billing();\n\x2b  private final Calculator calculator = new BillingCalculator(new Calculator(), billing);\n\n   @Test\n   void returnBalanceZero_whenNoCalculationsWereDone() {\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("3b5827e5830cc1b4d2153a1499b35277f01578c3").innerHTML = diffHtml;
</script>


<p>The test now compiles, but is red, no surprises here. The problem here is that <code>Billing</code> and <code>BillingCalculator</code> are completely separated from one another, yet somehow the information about executed calculations needs to flow between them. For a split second I was thinking about some common repository for the two, but luckily I don&rsquo;t need that. If I pass <code>Billing</code> into <code>BillingCalculator</code>, the latter can inform the former about all important things. Then the implementation could look like:</p>



<span id="cf4ebcbefd041c2724499a9fbfe4303ac828fab7"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -2,9 \x2b2,17 @@\n\n import java.math.BigDecimal;\n\n\x2bimport static java.math.BigDecimal.ZERO;\n\x2b\n public class Billing {\n\n\x2b  private BigDecimal balance = ZERO;\n\x2b\n   public BigDecimal getBalance() {\n-    return BigDecimal.ZERO;\n\x2b    return balance;\n\x2b  }\n\x2b\n\x2b  public void addToBalance(BigDecimal amount) {\n\x2b    balance = balance.add(amount);\n   }\n }\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n@@ -2,16 \x2b2,21 @@\n\n import com.webcalc.calculator.Calculator;\n\n\x2bimport static java.math.BigDecimal.ONE;\n\x2b\n public class BillingCalculator extends Calculator {\n\n   private final Calculator target;\n\x2b  private final Billing billing;\n\n-  public BillingCalculator(Calculator target) {\n\x2b  public BillingCalculator(Calculator target, Billing billing) {\n     this.target = target;\n\x2b    this.billing = billing;\n   }\n\n   @Override\n   public String eval(String input, int maxFractionDigits) {\n\x2b    billing.addToBalance(ONE);\n     return target.eval(input, maxFractionDigits);\n   }\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("cf4ebcbefd041c2724499a9fbfe4303ac828fab7").innerHTML = diffHtml;
</script>


<p>Of course, there&rsquo;s still a lot of faking, but the tests are green, and that&rsquo;s what I&rsquo;m after. One note, I&rsquo;m not going to be testing <code>BillingCaclculator</code> separately, it&rsquo;s part the whole billing module contract. Having separate tests for this class could make my life harder later on. Given the amount of faking I already did, sooner or later I&rsquo;ll need to refactor the code. Having tests only going through the actual API of a module means that the inner structure of a module is completely irrelevant. That&rsquo;s how I understand unit testing.</p>

<p>Little intermission here. As you might have noticed this iteration 6 is published long after iteration 5. I&rsquo;m sorry about that. But you can also see what I&rsquo;ve been working on in the meantime &ndash; the blog is no longer hosted on blogger.com, but rather <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>, built using <a href="https://www.gohugo.io/" target="_blank">Hugo</a> and available through my own domain. There&rsquo;s more than that, but maybe that&rsquo;s something for another time and place.</p>

<p>That pause made me go back and take a look at what I&rsquo;ve done so far in this iteration, and I&rsquo;ve found a problem. The decorator is a wrong pattern to use in here. Using it I only see the interaction between <code>CalculatorController</code> and <code>Calculator</code> twice, once when <code>CalculatorController</code> calls the <code>Calculator</code> and once when the <code>Calculator</code> returns a result. That&rsquo;s not enough. That means that the billing would need to also parse each expression and count all the operations by itself. That was my original thinking, as far as I can remember, but now I believe I should be using <a href="https://en.wikipedia.org/wiki/Observer_pattern" target="_blank">observer pattern</a>. I was thinking for a short time about creating two implementations and compare them at the end, but that would probably be too much.</p>

<p>So I&rsquo;m going back to commit <a href="https://github.com/jacekbilski/WebCalc/commit/579a1018c0ee8ee2b21fbe64d8a4ce7dfb5b32e8" target="_blank">commit 579a1018</a> and start over. Those two commits with the usage of the decorator pattern I&rsquo;ve pushed to the <a href="https://github.com/jacekbilski/WebCalc/tree/decorator" target="_blank">decorator</a> branch. This time it will not be possible to avoid any changes in the <code>Calculator</code>, but those changes will not be binding the module to anything, rather providing hooks from where interested parties could get the information they need. I have already one failing test in <code>BillingShould</code>, that&rsquo;s good.</p>

<p>I need a <code>calculator</code> and I need to register my <code>billing</code> as an observer, seems easy:</p>



<span id="69041cdfcd2483fa88bd9e9fbae8d8f23a6bbb92"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\x2b\x2b\x2b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -1,5 \x2b1,7 @@\n package com.webcalc.billing;\n\n\x2bimport com.webcalc.calculator.Calculator;\n\x2bimport org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n\n import java.math.BigDecimal;\n@@ -11,6 \x2b13,12 @@\n class BillingShould {\n\n   private final Billing billing = new Billing();\n\x2b  private final Calculator calculator = new Calculator();\n\x2b\n\x2b  @BeforeEach\n\x2b  void setUp() {\n\x2b    calculator.addObserver(billing);\n\x2b  }\n\n   @Test\n   void returnBalanceZero_whenNoCalculationsWereDone() {\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("69041cdfcd2483fa88bd9e9fbae8d8f23a6bbb92").innerHTML = diffHtml;
</script>


<p>Now I need to do two things, add <code>addObserver</code> method to <code>Calculator</code> that would be taking something implementing a new <code>CalculatorObserver</code> interface and make <code>Billing</code> implement that interface. Let&rsquo;s start with the <code>Calculator</code>.</p>



<span id="37a0ec29934a85a3cdbf8a12477209a26f73e792"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -1,8 \x2b1,10 @@\n package com.webcalc.billing;\n\n\x2bimport com.webcalc.calculator.CalculatorObserver;\n\x2b\n import java.math.BigDecimal;\n\n-public class Billing {\n\x2bpublic class Billing implements CalculatorObserver {\n\n   public BigDecimal getBalance() {\n     return BigDecimal.ZERO;\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -15,6 \x2b15,8 @@\n\n   private final NumberFormat formatter;\n\n\x2b  private CalculatorObserver observer;\n\x2b\n   public Calculator() {\n     formatter = DecimalFormat.getNumberInstance(Locale.GERMANY);\n     if (formatter instanceof DecimalFormat)\n@@ -66,4 \x2b68,8 @@\n     formatter.setMaximumFractionDigits(maxFractionDigits);\n     return formatter.format(result);\n   }\n\x2b\n\x2b  public void addObserver(CalculatorObserver observer) {\n\x2b    this.observer = observer;\n\x2b  }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n@@ -0,0 \x2b1,5 @@\n\x2bpackage com.webcalc.calculator;\n\x2b\n\x2bpublic interface CalculatorObserver {\n\x2b\n\x2b}\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("37a0ec29934a85a3cdbf8a12477209a26f73e792").innerHTML = diffHtml;
</script>


<p>For simplicity, I&rsquo;m now assuming that there can be only one observer. I can extend it later if need be. Also, the interface doesn&rsquo;t do anything just yet, but at least the compilation error is gone so I can run the tests again. Sure enough, one is still red.</p>

<p>Because the test is written in such a way that it doesn&rsquo;t matter what is being evaluated, the simplest thing that could possibly work could look like this:</p>



<span id="d49e7d427014c9dd90ce37b1cf48f360e5408f0d"></span>
<script>
    var diffHtml = Diff2Html.getPrettyHtml(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\x2b\x2b\x2b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -6,7 \x2b6,14 @@\n\n public class Billing implements CalculatorObserver {\n\n\x2b  private BigDecimal balance = BigDecimal.ZERO;\n\x2b\n   public BigDecimal getBalance() {\n-    return BigDecimal.ZERO;\n\x2b    return balance;\n\x2b  }\n\x2b\n\x2b  @Override\n\x2b  public void evaluated() {\n\x2b    balance = balance.add(BigDecimal.ONE);\n   }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -35,6 \x2b35,8 @@\n         var a = stack.pop();\n         var b = stack.pop();\n         stack.push(f.apply(b, a));\n\x2b        if (observer != null)\n\x2b          observer.evaluated();\n       }\n     }\n     return format(stack.pop(), maxFractionDigits);\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n\x2b\x2b\x2b calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n@@ -1,5 \x2b1,5 @@\n package com.webcalc.calculator;\n\n public interface CalculatorObserver {\n-\n\x2b  void evaluated();\n }\n",
        {inputFormat: 'diff', showFiles: false, matching: 'word', outputFormat: 'line-by-line'}
    );
    document.getElementById("d49e7d427014c9dd90ce37b1cf48f360e5408f0d").innerHTML = diffHtml;
</script>


<p>And I&rsquo;ll conclude this iteration here so that I can finally publish it. The original plan was to make every iteration out of one tomato of implementation plus then writing a blog post. Obviously, it doesn&rsquo;t work, mostly because I&rsquo;m writing code in parallel to post itself so that I can share my thoughts. But I will try to keep next iterations shorter, but publish them more often. Anyway, <a href="/posts/webcalc-iteration-7-billing/" target="_blank">next time</a> I&rsquo;ll be finishing tests for billing and making the implementation follow. I&rsquo;ll maybe also separate billing module from the app itself. See you next time!</p>

  </div>
  


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="jacekbilski/jacekbilski.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
