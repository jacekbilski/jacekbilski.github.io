<!DOCTYPE html>
<html lang="en-gb">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="Jacek Bilski">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Iteration 6 - introducing users • On Software Engineering</title>
<meta name="description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project.">
<meta name="keywords" content="JUnit 5, testing, tests, TDD">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iteration 6 - introducing users"/>
<meta name="twitter:description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project."/>
<meta name="twitter:site" content="@jacek_bilski"/>

<meta property="og:title" content="Iteration 6 - introducing users" />
<meta property="og:description" content="WebCalc sixth iteration. I&#39;m introducing users, so that I can start billing them for using my CPU time. That forces me to include Spring Security in the project." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.bilski.tech/posts/webcalc-iteration-6-introducing-users/" />
<meta property="article:published_time" content="2019-03-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-03-28T00:00:00+00:00" /><meta property="og:see_also" content="https://www.bilski.tech/posts/iteration-9-custom-functions/" /><meta property="og:see_also" content="https://www.bilski.tech/posts/webcalc-iteration-8-billing-module-extraction-and-differentiating-users/" /><meta property="og:see_also" content="https://www.bilski.tech/posts/webcalc-iteration-7-billing/" /><meta property="og:see_also" content="https://www.bilski.tech/posts/webcalc-iteration-5-more-complex-calculations/" /><meta property="og:see_also" content="https://www.bilski.tech/posts/webcalc-iteration-4-fixes-only/" />



    






<link rel="stylesheet" href="/scss/hyde-hyde.1edfcb2970975b6b5c3405c71d8ce6eb1bb64a550a9c090be52e9bb0235389a5.css" integrity="sha256-Ht/LKXCXW2tcNAXHHYzm6xu2SlUKnAkL5S6bsCNTiaU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

    
<link rel='stylesheet' type='text/css' href='https://cdn.jsdelivr.net/npm/diff2html@3.1.12/bundles/css/diff2html.min.css'/>
<style type='text/css'>
.d2h-wrapper {
    color: black;
    background: white;
    line-height: normal;
}
.d2h-wrapper td {
    padding: 0;
    border: none;
}
.d2h-wrapper table {
    margin-bottom: 0;
}
.d2h-file-diff {
    overflow-x: auto;
}
</style>
<script src='https://cdn.jsdelivr.net/npm/diff2html@3.1.12/bundles/js/diff2html.min.js'></script>


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.bilski.tech/">
        
          On Software Engineering
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://www.bilski.tech/img/jacek.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Jacek Bilski&#39;s thoughts about software engineering and how to improve it 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">On Software Engineering</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/various/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/webcalc/">
						<span>WebCalc</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/videos/">
						<span>Videos</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jacek_bilski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/jacekbilski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/jacek-bilski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	<a href="https://www.xing.com/profile/Jacek_Bilski3" rel="me"><i class="fab fa-xing fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Iteration 6 - introducing users</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 28, 2019<br/>
    
    <i class="fas fa-user-edit"></i> Jacek Bilski
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/junit-5">junit 5</a>
           
      
          <a class="badge badge-tag" href="/tags/testing">testing</a>
           
      
          <a class="badge badge-tag" href="/tags/tests">tests</a>
           
      
          <a class="badge badge-tag" href="/tags/tdd">tdd</a>
          
      
    
    
    <br/>
    
        <i class="fas fa-clock"></i> 14 min read
    
</div>


  </header>
  
  
  <div class="post">
    <p>Welcome to the 6th iteration of WebCalc. <a href="/posts/webcalc-iteration-5-more-complex-calculations/">Previously</a> I was dealing mostly with adding some more complex calculations. Like I mentioned there already, I think that I have already enough business logic to start moving into other areas like billing or user management. I also said that I&rsquo;d be going into the unknown. Up until now, I had a rough idea of how to do things, now I don&rsquo;t, I&rsquo;ll be exploring a lot.</p>
<p>Ultimately I want the application to bill the users, every operation should cost them some money and at the end of a month, an invoice will be prepared. Writing such a test now would make me work in red for days. I think, that the simplest test now would be to disallow anonymous users from doing any calculations, only logged in users can do something. That means, that I need to actually change my integration tests and add some test user there plus write a test that verifies that the system refuses to work without being logged in first.</p>
<p>There are many ways how users can authenticate themselves, but to keep things simple I&rsquo;d go for Basic Authentication. All those OAuth, OpenID or X509 are maybe more secure, can do more, but all that comes with much higher complexity. Long story short, username and password would need to be transferred on every request. That means that I also don&rsquo;t need any logging in functionality or page. That would also mean that I should be using HTTPS only.</p>
<p>My new test will be very simple, I&rsquo;ll just do the call without providing any authentication data and I&rsquo;ll expect to get HTTP 401 in return, like so:</p>


<span id="c57ae0441455a77bffc5cd252ce1b84e369ec115"></span>
<script>
    document.getElementById("c57ae0441455a77bffc5cd252ce1b84e369ec115").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -42,6 \u002b42,16 @@\n     assertEvalResult(\u00221 2 3 \u002b \u002b\u0022, \u00226\u0022);\n   }\n\n\u002b  @Test\n\u002b  void anonymousUsersCannotPerformCalculations() {\n\u002b    given()\n\u002b        .body(\u00221 2 \u002b\u0022)\n\u002b    .when()\n\u002b        .post(\u0022\/eval\u0022)\n\u002b    .then()\n\u002b        .statusCode(401);\n\u002b  }\n\u002b\n   private void setMaxFractionDigitsForSession(int maxFractionDigits, SessionFilter session) {\n     given()\n         .filter(session)\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>It fails because the HTTP status is still 200. I will already fix other tests to provide authentication data:</p>


<span id="170e0753cd2f1867bda41d8b373244ece74c9bbe"></span>
<script>
    document.getElementById("170e0753cd2f1867bda41d8b373244ece74c9bbe").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n@@ -12,6 \u002b12,9 @@\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n class RestApiTest {\n\n\u002b  private static final String DEFAULT_USERNAME = \u0022mmustermann\u0022;\n\u002b  private static final String DEFAULT_PASSWORD = \u00229786f3gb4508c2393q7y\u0022;\n\u002b\n   @Test\n   void invokesWebCalcRestApi() {\n     assertEvalResult(\u00221 2 \u002b\u0022, \u00223\u0022);\n@@ -55,6 \u002b58,7 @@\n   private void setMaxFractionDigitsForSession(int maxFractionDigits, SessionFilter session) {\n     given()\n         .filter(session)\n\u002b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n         .body(maxFractionDigits)\n     .when()\n         .put(\u0022\/maxFractionDigits\u0022)\n@@ -69,6 \u002b73,7 @@\n   private void assertEvalResultForSession(String expression, String expectedResult, SessionFilter session) {\n     given()\n         .filter(session)\n\u002b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n         .body(expression)\n     .when()\n         .post(\u0022\/eval\u0022)\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Time to include Spring Security in the project:</p>


<span id="dee9f4d8461b0053678dac72b7aba5755f82eee6"></span>
<script>
    document.getElementById("dee9f4d8461b0053678dac72b7aba5755f82eee6").innerHTML = Diff2Html.html(
        "Index: app\/build.gradle\n===================================================================\n--- app\/build.gradle\n\u002b\u002b\u002b app\/build.gradle\n@@ -9,6 \u002b9,7 @@\n dependencies {\n   implementation(project(\u0022:calculator\u0022))\n   implementation(\u0022org.springframework.boot:spring-boot-starter-web\u0022)\n\u002b  implementation(\u0022org.springframework.boot:spring-boot-starter-security\u0022)\n   testImplementation(\u0022org.springframework.boot:spring-boot-starter-test\u0022) {\n     exclude group: \u0022junit\u0022, module: \u0022junit\u0022\n   }\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Apparently, Spring Boot does most of the stuff for me the moment it sees Spring Security JAR on the classpath. My new test is already passing, all others are red. To get them working I need to do a few things. First, I need to &ldquo;add&rdquo; a default user to Spring Security&rsquo;s UserDetailsService:</p>


<span id="a9c2cef6b7d4b71883ddab52503a6ee4361947b8"></span>
<script>
    document.getElementById("a9c2cef6b7d4b71883ddab52503a6ee4361947b8").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/resources\/application.yaml\n===================================================================\n--- app\/src\/test\/resources\/application.yaml\n\u002b\u002b\u002b app\/src\/test\/resources\/application.yaml\n@@ -0,0 \u002b1,3 @@\n\u002bspring.security.user:\n\u002b  name: mmustermann\n\u002b  password: 9786f3gb4508c2393q7y\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>I also need to configure the security a little. By default, Spring requires a correct CSRF token, but with basic auth only that doesn&rsquo;t make much sense:</p>


<span id="0a0c67b20722a496db75b89e79d27b5876fe9977"></span>
<script>
    document.getElementById("0a0c67b20722a496db75b89e79d27b5876fe9977").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -5,6 \u002b5,9 @@\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.ComponentScan;\n\u002bimport org.springframework.context.annotation.Configuration;\n\u002bimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\n\u002bimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\n @SpringBootApplication\n @ComponentScan(\u0022com.webcalc\u0022)\n@@ -18,4 \u002b21,16 @@\n   public Calculator calculator() {\n     return new Calculator();\n   }\n\u002b\n\u002b  @Configuration\n\u002b  protected static class ApplicationSecurity extends WebSecurityConfigurerAdapter {\n\u002b\n\u002b    @Override\n\u002b    protected void configure(HttpSecurity http) throws Exception {\n\u002b      http.authorizeRequests()\n\u002b          .anyRequest().fullyAuthenticated()\n\u002b          .and().httpBasic()\n\u002b          .and().csrf().disable();\n\u002b    }\n\u002b  }\n }\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Now all my tests are once again green. So far so good, three small steps and I get my application secured. Sure, I only have one user and I&rsquo;m not using HTTPS, so those things will require additional effort, but still. Can I unit test the thing that I just did? Unfortunately, it doesn&rsquo;t seem possible and that&rsquo;s making me feel uneasy, but let&rsquo;s see how all this unfolds.</p>
<p>I don&rsquo;t see the need right now to go deeper into user management or creating different users. All that would only be necessary once I start billing them for using the system. And that is, honestly, the only reason I can think of right now why I need any authorization anyway. So let&rsquo;s go there. The idea is pretty simple, for every operation there&rsquo;s a price, so after each calculation is done I&rsquo;ll be adding its cost to the user&rsquo;s bill. Of course, different functions will have different prices and each usage of a function will be charged, for example for calculating <code>1+2+3</code> you&rsquo;d be charged twice for using sum.</p>
<p>One of the most interesting features for the users would be checking their current balance. I&rsquo;ll not surprise anybody by exposing this via REST. This would also give me a possibility to verify later on charging proper users with correct amounts. This requires a new endpoint because it&rsquo;s something else than calculations. It doesn&rsquo;t belong to the app module, it should get its own eventually, but let&rsquo;s start simple, I&rsquo;ll extract it later. A test will look something like this:</p>


<span id="17e43d031cdab1282037344fabd5bbd9e62798e9"></span>
<script>
    document.getElementById("17e43d031cdab1282037344fabd5bbd9e62798e9").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/integration_tests\/BillingApiShould.java\n@@ -0,0 \u002b1,26 @@\n\u002bpackage com.webcalc.integration_tests;\n\u002b\n\u002bimport com.webcalc.app.WebCalcApplication;\n\u002bimport org.junit.jupiter.api.Test;\n\u002bimport org.springframework.boot.test.context.SpringBootTest;\n\u002b\n\u002bimport static io.restassured.RestAssured.given;\n\u002bimport static org.hamcrest.Matchers.equalTo;\n\u002b\n\u002b@SpringBootTest(classes = WebCalcApplication.class,\n\u002b    webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n\u002bclass BillingApiShould {\n\u002b\n\u002b  private static final String DEFAULT_USERNAME = \u0022mmustermann\u0022;\n\u002b  private static final String DEFAULT_PASSWORD = \u00229786f3gb4508c2393q7y\u0022;\n\u002b\n\u002b  @Test\n\u002b  void returnsZeroWhenNoCalculationsDone() {\n\u002b    given()\n\u002b        .auth().preemptive().basic(DEFAULT_USERNAME, DEFAULT_PASSWORD)\n\u002b    .when()\n\u002b        .get(\u0022\/balance\u0022)\n\u002b    .then()\n\u002b        .body(equalTo(\u00220\u0022));\n\u002b  }\n\u002b}\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>The first thing that I&rsquo;ve noticed was inconsistent naming for test classes. I&rsquo;m still not sure if it&rsquo;s a blessing or a curse. On one hand, such inconsistencies affect readability or understandability of the code and, in effect, lead to errors in the code. On the other hand, going for nothing less than perfection is most likely not helping me deliver business value. In this case, it&rsquo;s a few renames, so let&rsquo;s do it. <code>RestApiTest</code> class will now be known as <code>CalculatorRestApiShould</code>. The idea with test classes ending with <code>should</code> is that when you read class name together with method names inside, they <a href="/posts/testing-is-storytelling/">tell &ldquo;a story&rdquo;</a>. I&rsquo;ve learned it from <a href="https://twitter.com/sandromancuso" target="_blank">Sandro Mancuso</a> and it does make sense. <code>CaclulatorShould</code> is already following this concept, <code>CalculatorRestApiShould</code> not yet, so:</p>


<span id="b830693ad60975f9b252ad0577778450b3870370"></span>
<script>
    document.getElementById("b830693ad60975f9b252ad0577778450b3870370").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/integration_tests\/RestApiTest.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/integration_tests\/CalculatorRestApiShould.java\n@@ -10,25 \u002b10,25 @@\n\n @SpringBootTest(classes = WebCalcApplication.class,\n     webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)\n-class RestApiTest {\n\u002bclass CalculatorRestApiShould {\n\n   private static final String DEFAULT_USERNAME = \u0022mmustermann\u0022;\n   private static final String DEFAULT_PASSWORD = \u00229786f3gb4508c2393q7y\u0022;\n\n   @Test\n-  void invokesWebCalcRestApi() {\n\u002b  void returnResult() {\n     assertEvalResult(\u00221 2 \u002b\u0022, \u00223\u0022);\n   }\n\n   @Test\n-  void settingMaxFractionDigits() {\n\u002b  void setMaxFractionDigits() {\n     SessionFilter session = new SessionFilter();\n     setMaxFractionDigitsForSession(5, session);\n     assertEvalResultForSession(\u00228 7 \/\u0022, \u00221,14286\u0022, session);\n   }\n\n   @Test\n-  void maxFractionDigitsAffectsOnlyCurrentSession() {\n\u002b  void setMaxFractionDigitsOnlyForCurrentSession() {\n     SessionFilter session1 = new SessionFilter();\n     SessionFilter session2 = new SessionFilter();\n     String expression = \u00228 7 \/\u0022;\n@@ -41,12 \u002b41,12 @@\n   }\n\n   @Test\n-  void canDoComplexCalculations() {\n\u002b  void doComplexCalculations() {\n     assertEvalResult(\u00221 2 3 \u002b \u002b\u0022, \u00226\u0022);\n   }\n\n   @Test\n-  void anonymousUsersCannotPerformCalculations() {\n\u002b  void preventAnonymousUsersFromPerformingCalculations() {\n     given()\n         .body(\u00221 2 \u002b\u0022)\n     .when()\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Back to the new API. The test is obviously red because I don&rsquo;t have the controller yet. That&rsquo;s easy to fix:</p>


<span id="a448867f2acbd62da5084a2e29cf8b799edbadee"></span>
<script>
    document.getElementById("a448867f2acbd62da5084a2e29cf8b799edbadee").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -0,0 \u002b1,13 @@\n\u002bpackage com.webcalc.billing;\n\u002b\n\u002bimport org.springframework.web.bind.annotation.GetMapping;\n\u002bimport org.springframework.web.bind.annotation.RestController;\n\u002b\n\u002b@RestController\n\u002bpublic class BillingController {\n\u002b\n\u002b  @GetMapping(\u0022\/balance\u0022)\n\u002b  public String getBalance() {\n\u002b    return \u00220\u0022;\n\u002b  }\n\u002b}\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>I should now push returning <code>0</code> down to some kind of service, for example:</p>


<span id="bb49647534e02c1ef43e9d4d4b498936ba0e7e25"></span>
<script>
    document.getElementById("bb49647534e02c1ef43e9d4d4b498936ba0e7e25").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/app\/WebCalcApplication.java\n@@ -1,5 \u002b1,6 @@\n package com.webcalc.app;\n\n\u002bimport com.webcalc.billing.Billing;\n import com.webcalc.calculator.Calculator;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n@@ -22,6 \u002b23,11 @@\n     return new Calculator();\n   }\n\n\u002b  @Bean\n\u002b  public Billing billing() {\n\u002b    return new Billing();\n\u002b  }\n\u002b\n   @Configuration\n   protected static class ApplicationSecurity extends WebSecurityConfigurerAdapter {\n\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -0,0 \u002b1,10 @@\n\u002bpackage com.webcalc.billing;\n\u002b\n\u002bimport java.math.BigDecimal;\n\u002b\n\u002bpublic class Billing {\n\u002b\n\u002b  public BigDecimal getBalance() {\n\u002b    return BigDecimal.ZERO;\n\u002b  }\n\u002b}\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/BillingController.java\n@@ -6,8 \u002b6,14 @@\n @RestController\n public class BillingController {\n\n\u002b  private final Billing billing;\n\u002b\n\u002b  public BillingController(Billing billing) {\n\u002b    this.billing = billing;\n\u002b  }\n\u002b\n   @GetMapping(\u0022\/balance\u0022)\n   public String getBalance() {\n-    return \u00220\u0022;\n\u002b    return billing.getBalance().toPlainString();\n   }\n }\nIndex: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -0,0 \u002b1,19 @@\n\u002bpackage com.webcalc.billing;\n\u002b\n\u002bimport org.junit.jupiter.api.Test;\n\u002b\n\u002bimport java.math.BigDecimal;\n\u002b\n\u002bimport static java.math.BigDecimal.ZERO;\n\u002bimport static org.assertj.core.api.Assertions.assertThat;\n\u002b\n\u002bclass BillingShould {\n\u002b\n\u002b  private final Billing billing = new Billing();\n\u002b\n\u002b  @Test\n\u002b  void returnBalanceZero_whenNoCalculationsWereDone() {\n\u002b    BigDecimal balance = billing.getBalance();\n\u002b    assertThat(balance).isEqualByComparingTo(ZERO);\n\u002b  }\n\u002b}\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Now things get much more interesting. Next logical step is to define a price for a function, execute a calculation using this function and see, that the balance increased. I&rsquo;ll still blissfully ignore the existence of different users. I can also still get away with not persisting anything &ldquo;for real&rdquo;. The tricky part is, that I want the calculator to be completely unaffected by billing, the module should not depend on the billing module. Obviously, billing would need to depend on the calculator. I can quite easily achieve this with a <a href="https://en.wikipedia.org/wiki/Decorator_pattern" target="_blank">decorator pattern</a>. But before I go in there, I need a test:</p>


<span id="e617f2b3a4fd97416b72cc0f7cf40d22e8110ad9"></span>
<script>
    document.getElementById("e617f2b3a4fd97416b72cc0f7cf40d22e8110ad9").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -4,6 \u002b4,7 @@\n\n import java.math.BigDecimal;\n\n\u002bimport static java.math.BigDecimal.ONE;\n import static java.math.BigDecimal.ZERO;\n import static org.assertj.core.api.Assertions.assertThat;\n\n@@ -16,4 \u002b17,11 @@\n     BigDecimal balance = billing.getBalance();\n     assertThat(balance).isEqualByComparingTo(ZERO);\n   }\n\u002b\n\u002b  @Test\n\u002b  void returnBalanceOfOne_afterCalculatingOneSum() {\n\u002b    calculator.eval(\u00221 2 \u002b\u0022, 0);\n\u002b    BigDecimal balance = billing.getBalance();\n\u002b    assertThat(balance).isEqualByComparingTo(ONE);\n\u002b  }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\u002b\u002b\u002b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -21,7 \u002b21,7 @@\n       ((DecimalFormat) formatter).setParseBigDecimal(true);\n   }\n\n-  String eval(String input, int maxFractionDigits) {\n\u002b  public String eval(String input, int maxFractionDigits) {\n     String[] tokens = input.split(\u0022 \u0022);\n     var stack = new Stack\u003cBigDecimal\u003e();\n     for (String token : tokens) {\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Looks simple enough, but I don&rsquo;t have <code>calculator</code>. I need to create a <code>BillingCalculator</code>, that will be a decorator of a &ldquo;real&rdquo; calculator, it will look like this:</p>


<span id="24d48b36ffdf86fdc9216360f3c0f4037318a477"></span>
<script>
    document.getElementById("24d48b36ffdf86fdc9216360f3c0f4037318a477").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n@@ -0,0 \u002b1,17 @@\n\u002bpackage com.webcalc.billing;\n\u002b\n\u002bimport com.webcalc.calculator.Calculator;\n\u002b\n\u002bpublic class BillingCalculator extends Calculator {\n\u002b\n\u002b  private final Calculator target;\n\u002b\n\u002b  public BillingCalculator(Calculator target) {\n\u002b    this.target = target;\n\u002b  }\n\u002b\n\u002b  @Override\n\u002b  public String eval(String input, int maxFractionDigits) {\n\u002b    return target.eval(input, maxFractionDigits);\n\u002b  }\n\u002b}\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>For now the only thing it can is to delegate a call to another calculator that was passed into it. This other calculator might be an actual calculator, the one I&rsquo;ve been writing so far, but it could also be a mock or anything else that can behave like a calculator. I&rsquo;ll go yet again simple and use the real one. The fixed test looks like this:</p>


<span id="3b5827e5830cc1b4d2153a1499b35277f01578c3"></span>
<script>
    document.getElementById("3b5827e5830cc1b4d2153a1499b35277f01578c3").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -1,5 \u002b1,6 @@\n package com.webcalc.billing;\n\n\u002bimport com.webcalc.calculator.Calculator;\n import org.junit.jupiter.api.Test;\n\n import java.math.BigDecimal;\n@@ -11,6 \u002b12,7 @@\n class BillingShould {\n\n   private final Billing billing = new Billing();\n\u002b  private final Calculator calculator = new BillingCalculator(new Calculator(), billing);\n\n   @Test\n   void returnBalanceZero_whenNoCalculationsWereDone() {\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>The test now compiles, but is red, no surprises here. The problem here is that <code>Billing</code> and <code>BillingCalculator</code> are completely separated from one another, yet somehow the information about executed calculations needs to flow between them. For a split second I was thinking about some common repository for the two, but luckily I don&rsquo;t need that. If I pass <code>Billing</code> into <code>BillingCalculator</code>, the latter can inform the former about all important things. Then the implementation could look like:</p>


<span id="cf4ebcbefd041c2724499a9fbfe4303ac828fab7"></span>
<script>
    document.getElementById("cf4ebcbefd041c2724499a9fbfe4303ac828fab7").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -2,9 \u002b2,17 @@\n\n import java.math.BigDecimal;\n\n\u002bimport static java.math.BigDecimal.ZERO;\n\u002b\n public class Billing {\n\n\u002b  private BigDecimal balance = ZERO;\n\u002b\n   public BigDecimal getBalance() {\n-    return BigDecimal.ZERO;\n\u002b    return balance;\n\u002b  }\n\u002b\n\u002b  public void addToBalance(BigDecimal amount) {\n\u002b    balance = balance.add(amount);\n   }\n }\nIndex: app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/BillingCalculator.java\n@@ -2,16 \u002b2,21 @@\n\n import com.webcalc.calculator.Calculator;\n\n\u002bimport static java.math.BigDecimal.ONE;\n\u002b\n public class BillingCalculator extends Calculator {\n\n   private final Calculator target;\n\u002b  private final Billing billing;\n\n-  public BillingCalculator(Calculator target) {\n\u002b  public BillingCalculator(Calculator target, Billing billing) {\n     this.target = target;\n\u002b    this.billing = billing;\n   }\n\n   @Override\n   public String eval(String input, int maxFractionDigits) {\n\u002b    billing.addToBalance(ONE);\n     return target.eval(input, maxFractionDigits);\n   }\n }\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Of course, there&rsquo;s still a lot of faking, but the tests are green, and that&rsquo;s what I&rsquo;m after. One note, I&rsquo;m not going to be testing <code>BillingCaclculator</code> separately, it&rsquo;s part the whole billing module contract. Having separate tests for this class could make my life harder later on. Given the amount of faking I already did, sooner or later I&rsquo;ll need to refactor the code. Having tests only going through the actual API of a module means that the inner structure of a module is completely irrelevant. That&rsquo;s how I understand unit testing.</p>
<p>Little intermission here. As you might have noticed this iteration 6 is published long after iteration 5. I&rsquo;m sorry about that. But you can also see what I&rsquo;ve been working on in the meantime &ndash; the blog is no longer hosted on blogger.com, but rather <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>, built using <a href="https://www.gohugo.io/" target="_blank">Hugo</a> and available through my own domain. There&rsquo;s more than that, but maybe that&rsquo;s something for another time and place.</p>
<p>That pause made me go back and take a look at what I&rsquo;ve done so far in this iteration, and I&rsquo;ve found a problem. The decorator is a wrong pattern to use in here. Using it I only see the interaction between <code>CalculatorController</code> and <code>Calculator</code> twice, once when <code>CalculatorController</code> calls the <code>Calculator</code> and once when the <code>Calculator</code> returns a result. That&rsquo;s not enough. That means that the billing would need to also parse each expression and count all the operations by itself. That was my original thinking, as far as I can remember, but now I believe I should be using <a href="https://en.wikipedia.org/wiki/Observer_pattern" target="_blank">observer pattern</a>. I was thinking for a short time about creating two implementations and compare them at the end, but that would probably be too much.</p>
<p>So I&rsquo;m going back to commit <a href="https://github.com/jacekbilski/WebCalc/commit/579a1018c0ee8ee2b21fbe64d8a4ce7dfb5b32e8" target="_blank">commit 579a1018</a> and start over. Those two commits with the usage of the decorator pattern I&rsquo;ve pushed to the <a href="https://github.com/jacekbilski/WebCalc/tree/decorator" target="_blank">decorator</a> branch. This time it will not be possible to avoid any changes in the <code>Calculator</code>, but those changes will not be binding the module to anything, rather providing hooks from where interested parties could get the information they need. I have already one failing test in <code>BillingShould</code>, that&rsquo;s good.</p>
<p>I need a <code>calculator</code> and I need to register my <code>billing</code> as an observer, seems easy:</p>


<span id="69041cdfcd2483fa88bd9e9fbae8d8f23a6bbb92"></span>
<script>
    document.getElementById("69041cdfcd2483fa88bd9e9fbae8d8f23a6bbb92").innerHTML = Diff2Html.html(
        "Index: app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n===================================================================\n--- app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n\u002b\u002b\u002b app\/src\/test\/java\/com\/webcalc\/billing\/BillingShould.java\n@@ -1,5 \u002b1,7 @@\n package com.webcalc.billing;\n\n\u002bimport com.webcalc.calculator.Calculator;\n\u002bimport org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n\n import java.math.BigDecimal;\n@@ -11,6 \u002b13,12 @@\n class BillingShould {\n\n   private final Billing billing = new Billing();\n\u002b  private final Calculator calculator = new Calculator();\n\u002b\n\u002b  @BeforeEach\n\u002b  void setUp() {\n\u002b    calculator.addObserver(billing);\n\u002b  }\n\n   @Test\n   void returnBalanceZero_whenNoCalculationsWereDone() {\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>Now I need to do two things, add <code>addObserver</code> method to <code>Calculator</code> that would be taking something implementing a new <code>CalculatorObserver</code> interface and make <code>Billing</code> implement that interface. Let&rsquo;s start with the <code>Calculator</code>.</p>


<span id="37a0ec29934a85a3cdbf8a12477209a26f73e792"></span>
<script>
    document.getElementById("37a0ec29934a85a3cdbf8a12477209a26f73e792").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -1,8 \u002b1,10 @@\n package com.webcalc.billing;\n\n\u002bimport com.webcalc.calculator.CalculatorObserver;\n\u002b\n import java.math.BigDecimal;\n\n-public class Billing {\n\u002bpublic class Billing implements CalculatorObserver {\n\n   public BigDecimal getBalance() {\n     return BigDecimal.ZERO;\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\u002b\u002b\u002b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -15,6 \u002b15,8 @@\n\n   private final NumberFormat formatter;\n\n\u002b  private CalculatorObserver observer;\n\u002b\n   public Calculator() {\n     formatter = DecimalFormat.getNumberInstance(Locale.GERMANY);\n     if (formatter instanceof DecimalFormat)\n@@ -66,4 \u002b68,8 @@\n     formatter.setMaximumFractionDigits(maxFractionDigits);\n     return formatter.format(result);\n   }\n\u002b\n\u002b  public void addObserver(CalculatorObserver observer) {\n\u002b    this.observer = observer;\n\u002b  }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n\u002b\u002b\u002b calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n@@ -0,0 \u002b1,5 @@\n\u002bpackage com.webcalc.calculator;\n\u002b\n\u002bpublic interface CalculatorObserver {\n\u002b\n\u002b}\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>For simplicity, I&rsquo;m now assuming that there can be only one observer. I can extend it later if need be. Also, the interface doesn&rsquo;t do anything just yet, but at least the compilation error is gone so I can run the tests again. Sure enough, one is still red.</p>
<p>Because the test is written in such a way that it doesn&rsquo;t matter what is being evaluated, the simplest thing that could possibly work could look like this:</p>


<span id="d49e7d427014c9dd90ce37b1cf48f360e5408f0d"></span>
<script>
    document.getElementById("d49e7d427014c9dd90ce37b1cf48f360e5408f0d").innerHTML = Diff2Html.html(
        "Index: app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n===================================================================\n--- app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n\u002b\u002b\u002b app\/src\/main\/java\/com\/webcalc\/billing\/Billing.java\n@@ -6,7 \u002b6,14 @@\n\n public class Billing implements CalculatorObserver {\n\n\u002b  private BigDecimal balance = BigDecimal.ZERO;\n\u002b\n   public BigDecimal getBalance() {\n-    return BigDecimal.ZERO;\n\u002b    return balance;\n\u002b  }\n\u002b\n\u002b  @Override\n\u002b  public void evaluated() {\n\u002b    balance = balance.add(BigDecimal.ONE);\n   }\n }\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n\u002b\u002b\u002b calculator\/src\/main\/java\/com\/webcalc\/calculator\/Calculator.java\n@@ -35,6 \u002b35,8 @@\n         var a = stack.pop();\n         var b = stack.pop();\n         stack.push(f.apply(b, a));\n\u002b        if (observer != null)\n\u002b          observer.evaluated();\n       }\n     }\n     return format(stack.pop(), maxFractionDigits);\nIndex: calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n===================================================================\n--- calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n\u002b\u002b\u002b calculator\/src\/main\/java\/com\/webcalc\/calculator\/CalculatorObserver.java\n@@ -1,5 \u002b1,5 @@\n package com.webcalc.calculator;\n\n public interface CalculatorObserver {\n-\n\u002b  void evaluated();\n }\n",
        {drawFileList: false, matching: 'lines', outputFormat: 'line-by-line'}
    );
</script>

<p>And I&rsquo;ll conclude this iteration here so that I can finally publish it. The original plan was to make every iteration out of one tomato of implementation plus then writing a blog post. Obviously, it doesn&rsquo;t work, mostly because I&rsquo;m writing code in parallel to post itself so that I can share my thoughts. But I will try to keep next iterations shorter, but publish them more often. Anyway, <a href="/posts/webcalc-iteration-7-billing/">next time</a> I&rsquo;ll be finishing tests for billing and making the implementation follow. I&rsquo;ll maybe also separate billing module from the app itself. See you next time!</p>

  </div>
  


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="jacekbilski/jacekbilski.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>




    



    </body>
</html>
